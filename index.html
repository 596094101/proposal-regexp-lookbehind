<!doctype html>
<head><meta charset="utf-8">
<title>RegExp Lookbehind Assertions</title><script type="application/json" id="menu-search-biblio">[{"type":"clause","id":"sec-introduction","aoid":null,"title":"Introduction","titleHTML":"Introduction","number":"1","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Introduction"},{"type":"production","id":"prod-Pattern","name":"Pattern","referencingIds":[],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Pattern"},{"type":"production","id":"prod-Disjunction","name":"Disjunction","referencingIds":["_ref_19","_ref_22","_ref_29","_ref_30","_ref_31","_ref_32","_ref_38","_ref_39","_ref_77","_ref_78","_ref_82","_ref_84","_ref_86","_ref_88","_ref_91","_ref_114","_ref_116","_ref_119","_ref_140","_ref_141","_ref_142","_ref_143","_ref_144","_ref_145","_ref_146","_ref_147","_ref_154","_ref_155","_ref_156","_ref_158","_ref_160","_ref_161","_ref_162","_ref_163","_ref_164","_ref_165","_ref_166","_ref_167","_ref_168","_ref_169","_ref_170","_ref_171","_ref_172"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Disjunction"},{"type":"production","id":"prod-Alternative","name":"Alternative","referencingIds":["_ref_20","_ref_21","_ref_23","_ref_79","_ref_80","_ref_81","_ref_83","_ref_85","_ref_87","_ref_89","_ref_90","_ref_92","_ref_93","_ref_95","_ref_98","_ref_102","_ref_103"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Alternative"},{"type":"production","id":"prod-Term","name":"Term","referencingIds":["_ref_24","_ref_94","_ref_96","_ref_97","_ref_99","_ref_100","_ref_101","_ref_104","_ref_113","_ref_115","_ref_117"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Term"},{"type":"production","id":"prod-Assertion","name":"Assertion","referencingIds":["_ref_25","_ref_105","_ref_106"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Assertion"},{"type":"production","id":"prod-Quantifier","name":"Quantifier","referencingIds":["_ref_28","_ref_110","_ref_112","_ref_122","_ref_123","_ref_124"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Quantifier"},{"type":"production","id":"prod-QuantifierPrefix","name":"QuantifierPrefix","referencingIds":["_ref_33","_ref_34"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"QuantifierPrefix"},{"type":"production","id":"prod-Atom","name":"Atom","referencingIds":["_ref_26","_ref_27","_ref_107","_ref_108","_ref_109","_ref_111","_ref_118","_ref_120","_ref_121","_ref_125","_ref_126","_ref_127","_ref_128","_ref_129","_ref_130","_ref_131","_ref_132","_ref_133","_ref_134","_ref_135","_ref_136","_ref_137","_ref_138","_ref_139","_ref_157","_ref_159"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"Atom"},{"type":"production","id":"prod-SyntaxCharacter","name":"SyntaxCharacter","referencingIds":["_ref_40","_ref_57"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"SyntaxCharacter"},{"type":"production","id":"prod-PatternCharacter","name":"PatternCharacter","referencingIds":["_ref_35","_ref_148","_ref_149"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"PatternCharacter"},{"type":"production","id":"prod-AtomEscape","name":"AtomEscape","referencingIds":["_ref_36","_ref_150","_ref_151"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"AtomEscape"},{"type":"production","id":"prod-CharacterEscape","name":"CharacterEscape","referencingIds":["_ref_43","_ref_76","_ref_175","_ref_176"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"CharacterEscape"},{"type":"production","id":"prod-ControlEscape","name":"ControlEscape","referencingIds":["_ref_44"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ControlEscape"},{"type":"production","id":"prod-ControlLetter","name":"ControlLetter","referencingIds":["_ref_45"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ControlLetter"},{"type":"production","id":"prod-RegExpUnicodeEscapeSequence","name":"RegExpUnicodeEscapeSequence","referencingIds":["_ref_46"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"RegExpUnicodeEscapeSequence"},{"type":"production","id":"prod-LeadSurrogate","name":"LeadSurrogate","referencingIds":["_ref_48","_ref_50","_ref_54","_ref_55"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"LeadSurrogate"},{"type":"production","id":"prod-TrailSurrogate","name":"TrailSurrogate","referencingIds":["_ref_49","_ref_51","_ref_53","_ref_56"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"TrailSurrogate"},{"type":"production","id":"prod-NonSurrogate","name":"NonSurrogate","referencingIds":["_ref_52"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"NonSurrogate"},{"type":"production","id":"prod-IdentityEscape","name":"IdentityEscape","referencingIds":["_ref_47"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"IdentityEscape"},{"type":"production","id":"prod-DecimalEscape","name":"DecimalEscape","referencingIds":["_ref_41","_ref_173","_ref_174"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"DecimalEscape"},{"type":"production","id":"prod-CharacterClassEscape","name":"CharacterClassEscape","referencingIds":["_ref_42","_ref_75","_ref_177","_ref_178"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"CharacterClassEscape"},{"type":"production","id":"prod-CharacterClass","name":"CharacterClass","referencingIds":["_ref_37","_ref_152","_ref_153"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"CharacterClass"},{"type":"production","id":"prod-ClassRanges","name":"ClassRanges","referencingIds":["_ref_58","_ref_59","_ref_66","_ref_72"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ClassRanges"},{"type":"production","id":"prod-NonemptyClassRanges","name":"NonemptyClassRanges","referencingIds":["_ref_60"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"NonemptyClassRanges"},{"type":"production","id":"prod-NonemptyClassRangesNoDash","name":"NonemptyClassRangesNoDash","referencingIds":["_ref_63","_ref_69"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"NonemptyClassRangesNoDash"},{"type":"production","id":"prod-ClassAtom","name":"ClassAtom","referencingIds":["_ref_61","_ref_62","_ref_64","_ref_65","_ref_67","_ref_71"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ClassAtom"},{"type":"production","id":"prod-ClassAtomNoDash","name":"ClassAtomNoDash","referencingIds":["_ref_68","_ref_70","_ref_73"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ClassAtomNoDash"},{"type":"production","id":"prod-ClassEscape","name":"ClassEscape","referencingIds":["_ref_74"],"namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","key":"ClassEscape"},{"type":"clause","id":"sec-patternsyntax","aoid":null,"title":"Pattern Syntax","titleHTML":"Pattern Syntax","number":"2","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Pattern Syntax"},{"type":"clause","id":"sec-pattern","aoid":null,"title":"Pattern","titleHTML":"Pattern","number":"3.1","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Pattern"},{"type":"clause","id":"sec-disjunction","aoid":null,"title":"Disjunction","titleHTML":"Disjunction","number":"3.2","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Disjunction"},{"type":"clause","id":"sec-alternative","aoid":null,"title":"Alternative","titleHTML":"Alternative","number":"3.3","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Alternative"},{"type":"op","aoid":"RepeatMatcher","refId":"sec-runtime-semantics-repeatmatcher-abstract-operation","location":"","referencingIds":[],"key":"RepeatMatcher"},{"type":"clause","id":"sec-runtime-semantics-repeatmatcher-abstract-operation","aoid":"RepeatMatcher","title":"Runtime Semantics: RepeatMatcher Abstract Operation","titleHTML":"Runtime Semantics: RepeatMatcher Abstract Operation","number":"3.4.1","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":["_ref_1","_ref_2"],"key":"Runtime Semantics: RepeatMatcher Abstract Operation"},{"type":"clause","id":"sec-term","aoid":null,"title":"Term","titleHTML":"Term","number":"3.4","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Term"},{"type":"op","aoid":"WordCharacters","refId":"sec-runtime-semantics-wordcharacters-abstract-operation","location":"","referencingIds":[],"key":"WordCharacters"},{"type":"clause","id":"sec-runtime-semantics-wordcharacters-abstract-operation","aoid":"WordCharacters","title":"Runtime Semantics: WordCharacters Abstract Operation","titleHTML":"Runtime Semantics: WordCharacters Abstract Operation","number":"3.5.1","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":["_ref_8"],"key":"Runtime Semantics: WordCharacters Abstract Operation"},{"type":"op","aoid":"IsWordChar","refId":"sec-runtime-semantics-iswordchar-abstract-operation","location":"","referencingIds":[],"key":"IsWordChar"},{"type":"clause","id":"sec-runtime-semantics-iswordchar-abstract-operation","aoid":"IsWordChar","title":"Runtime Semantics: IsWordChar Abstract Operation","titleHTML":"Runtime Semantics: IsWordChar Abstract Operation","number":"3.5.2","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":["_ref_3","_ref_4","_ref_5","_ref_6"],"key":"Runtime Semantics: IsWordChar Abstract Operation"},{"type":"clause","id":"sec-assertion","aoid":null,"title":"Assertion","titleHTML":"Assertion","number":"3.5","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Assertion"},{"type":"op","aoid":"CharacterSetMatcher","refId":"sec-runtime-semantics-charactersetmatcher-abstract-operation","location":"","referencingIds":[],"key":"CharacterSetMatcher"},{"type":"clause","id":"sec-runtime-semantics-charactersetmatcher-abstract-operation","aoid":"CharacterSetMatcher","title":"Runtime Semantics: CharacterSetMatcher Abstract Operation","titleHTML":"Runtime Semantics: CharacterSetMatcher Abstract Operation","number":"3.6.1","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":["_ref_9","_ref_10","_ref_11","_ref_17","_ref_18"],"key":"Runtime Semantics: CharacterSetMatcher Abstract Operation"},{"type":"op","aoid":"Canonicalize","refId":"sec-runtime-semantics-canonicalize-ch","location":"","referencingIds":[],"key":"Canonicalize"},{"type":"clause","id":"sec-runtime-semantics-canonicalize-ch","aoid":"Canonicalize","title":"Runtime Semantics: Canonicalize ( ch )","titleHTML":"Runtime Semantics: Canonicalize ( <var>ch</var> )","number":"3.6.2","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":["_ref_7","_ref_12","_ref_13","_ref_14","_ref_15","_ref_16"],"key":"Runtime Semantics: Canonicalize ( ch )"},{"type":"clause","id":"sec-atom","aoid":null,"title":"Atom","titleHTML":"Atom","number":"3.6","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Atom"},{"type":"clause","id":"sec-atomescape","aoid":null,"title":"AtomEscape","titleHTML":"AtomEscape","number":"3.7","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"AtomEscape"},{"type":"clause","id":"sec-patternsemantics","aoid":null,"title":"Pattern Semantics","titleHTML":"Pattern Semantics","number":"3","namespace":"https://github.com/tc39/proposal-regexp-lookbehind","location":"","referencingIds":[],"key":"Pattern Semantics"}]</script><script>"use strict";

function Search(menu) {
  this.menu = menu;
  this.$search = document.getElementById('menu-search');
  this.$searchBox = document.getElementById('menu-search-box');
  this.$searchResults = document.getElementById('menu-search-results');
  
  this.loadBiblio();
  
  document.addEventListener('keydown', this.documentKeydown.bind(this));
  
  this.$searchBox.addEventListener('keydown', debounce(this.searchBoxKeydown.bind(this), { stopPropagation: true }));
  this.$searchBox.addEventListener('keyup', debounce(this.searchBoxKeyup.bind(this), { stopPropagation: true }));
}

Search.prototype.loadBiblio = function () {
  var $biblio = document.getElementById('menu-search-biblio');
  if (!$biblio) {
    this.biblio = [];
  } else {
    this.biblio = JSON.parse($biblio.textContent);
    this.biblio.clauses = this.biblio.filter(function (e) { return e.type === 'clause' });
    this.biblio.byId = this.biblio.reduce(function (map, entry) {
      map[entry.id] = entry;
      return map;
    }, {});
  }
}

Search.prototype.documentKeydown = function (e) {
  if (e.keyCode === 191) {
    e.preventDefault();
    e.stopPropagation();
    this.triggerSearch();
  }
}

Search.prototype.searchBoxKeydown = function (e) {
  e.stopPropagation();
  e.preventDefault();
  if (e.keyCode === 191 && e.target.value.length === 0) {
    e.preventDefault();
  } else if (e.keyCode === 13) {
    e.preventDefault();
    this.selectResult();
  }
}

Search.prototype.searchBoxKeyup = function (e) {
  if (e.keyCode === 13 || e.keyCode === 9) {
    return;
  }
  
  this.search(e.target.value);
}


Search.prototype.triggerSearch = function (e) {
  if (this.menu.isVisible()) {
    this._closeAfterSearch = false;
  } else {
    this._closeAfterSearch = true;
    this.menu.show();
  }

  this.$searchBox.focus();
  this.$searchBox.select();
}
// bit 12 - Set if the result starts with searchString
// bits 8-11: 8 - number of chunks multiplied by 2 if cases match, otherwise 1.
// bits 1-7: 127 - length of the entry
// General scheme: prefer case sensitive matches with fewer chunks, and otherwise
// prefer shorter matches.
function relevance(result, searchString) {
  var relevance = 0;
  
  relevance = Math.max(0, 8 - result.match.chunks) << 7;
  
  if (result.match.caseMatch) {
    relevance *= 2;
  }
  
  if (result.match.prefix) {
    relevance += 2048
  }
  
  relevance += Math.max(0, 255 - result.entry.key.length);
  
  return relevance;
}

Search.prototype.search = function (searchString) {
  var s = Date.now();

  if (searchString === '') {
    this.displayResults([]);
    this.hideSearch();
    return;
  } else {
    this.showSearch();
  }
  
  if (searchString.length === 1) {
    this.displayResults([]);
    return;
  }
    
  var results;

  if (/^[\d\.]*$/.test(searchString)) {
    results = this.biblio.clauses.filter(function (clause) {
      return clause.number.substring(0, searchString.length) === searchString;
    }).map(function (clause) {
      return { entry: clause };
    });
  } else {
    results = [];
    
    for (var i = 0; i < this.biblio.length; i++) {
      var entry = this.biblio[i];
  
      var match = fuzzysearch(searchString, entry.key);
      if (match) {
        results.push({ entry: entry, match: match });
      }
    }
  
    results.forEach(function (result) {
      result.relevance = relevance(result, searchString);
    });
    
    results = results.sort(function (a, b) { return b.relevance - a.relevance });

  }

  if (results.length > 50) {
    results = results.slice(0, 50);
  }
  
  this.displayResults(results);
}
Search.prototype.hideSearch = function () {
  this.$search.classList.remove('active');
}

Search.prototype.showSearch = function () {
  this.$search.classList.add('active');
}

Search.prototype.selectResult = function () {
  var $first = this.$searchResults.querySelector('li:first-child a');

  if ($first) {
    document.location = $first.getAttribute('href');
  }
  
  this.$searchBox.value = '';
  this.$searchBox.blur();
  this.displayResults([]);
  this.hideSearch();

  if (this._closeAfterSearch) {
    this.menu.hide();
  }
}

Search.prototype.displayResults = function (results) {
  if (results.length > 0) {
    this.$searchResults.classList.remove('no-results');
    
    var html = '<ul>';

    results.forEach(function (result) {
      var entry = result.entry;
      var id = entry.id;
      var cssClass = '';
      var text = '';

      if (entry.type === 'clause') {
        var number = entry.number ? entry.number + ' ' : '';
        text = number + entry.key;
        cssClass = 'clause';
        id = entry.id;
      } else if (entry.type === 'production') {
        text = entry.key;
        cssClass = 'prod';
        id = entry.id;  
      } else if (entry.type === 'op') {
        text = entry.key;
        cssClass = 'op';
        id = entry.id || entry.refId;
      } else if (entry.type === 'term') {
        text = entry.key;
        cssClass = 'term';
        id = entry.id || entry.refId;
      }

      if (text) {
        html += '<li class=menu-search-result-' + cssClass + '><a href="#' + id + '">' + text + '</a></li>'
      }
    });

    html += '</ul>'

    this.$searchResults.innerHTML = html;
  } else {
    this.$searchResults.innerHTML = '';
    this.$searchResults.classList.add('no-results');
  }
}


function Menu() {
  this.$toggle = document.getElementById('menu-toggle');
  this.$menu = document.getElementById('menu');
  this.$toc = document.querySelector('menu-toc > ol');
  this.$pins = document.querySelector('#menu-pins');
  this.$pinList = document.getElementById('menu-pins-list');
  this.$toc = document.querySelector('#menu-toc > ol');
  this.$specContainer = document.getElementById('spec-container');
  this.search = new Search(this);
  
  this._pinnedIds = {}; 
  this.loadPinEntries();

  // toggle menu
  this.$toggle.addEventListener('click', this.toggle.bind(this));

  // keydown events for pinned clauses
  document.addEventListener('keydown', this.documentKeydown.bind(this));

  // toc expansion
  var tocItems = this.$menu.querySelectorAll('#menu-toc li');
  for (var i = 0; i < tocItems.length; i++) {
    var $item = tocItems[i];
    $item.addEventListener('click', function($item, event) {
      $item.classList.toggle('active');
      event.stopPropagation();
    }.bind(null, $item));
  }

  // close toc on toc item selection
  var tocLinks = this.$menu.querySelectorAll('#menu-toc li > a');
  for (var i = 0; i < tocLinks.length; i++) {
    var $link = tocLinks[i];
    $link.addEventListener('click', function(event) {
      this.toggle();
      event.stopPropagation();
    }.bind(this));
  }

  // update active clause on scroll
  window.addEventListener('scroll', debounce(this.updateActiveClause.bind(this)));
  this.updateActiveClause();

  // prevent menu scrolling from scrolling the body
  this.$toc.addEventListener('wheel', function (e) {
    var target = e.currentTarget;
    var offTop = e.deltaY < 0 && target.scrollTop === 0;
    if (offTop) {
      e.preventDefault();
    }
    var offBottom = e.deltaY > 0
                    && target.offsetHeight + target.scrollTop >= target.scrollHeight;

    if (offBottom) {
		  e.preventDefault();
	  }
  })
}

Menu.prototype.documentKeydown = function (e) {
  e.stopPropagation();
  if (e.keyCode === 80) {
    this.togglePinEntry();
  } else if (e.keyCode > 48 && e.keyCode < 58) {
    this.selectPin(e.keyCode - 49);
  }
}

Menu.prototype.updateActiveClause = function () {
  this.setActiveClause(findActiveClause(this.$specContainer))
}

Menu.prototype.setActiveClause = function (clause) {
  this.$activeClause = clause;
  this.revealInToc(this.$activeClause);
}

Menu.prototype.revealInToc = function (path) {
  var current = this.$toc.querySelectorAll('li.revealed');
  for (var i = 0; i < current.length; i++) {
    current[i].classList.remove('revealed');
    current[i].classList.remove('revealed-leaf');
  }
  
  var current = this.$toc;
  var index = 0;
  while (index < path.length) {
    var children = current.children;
    for (var i = 0; i < children.length; i++) {
      if ('#' + path[index].id === children[i].children[1].getAttribute('href') ) {
        children[i].classList.add('revealed');
        if (index === path.length - 1) {
          children[i].classList.add('revealed-leaf');
          var rect = children[i].getBoundingClientRect();
          this.$toc.getBoundingClientRect().top
          var tocRect = this.$toc.getBoundingClientRect();
          if (rect.top + 10 > tocRect.bottom) {
            this.$toc.scrollTop = this.$toc.scrollTop + (rect.top - tocRect.bottom) + (rect.bottom - rect.top);
          } else if (rect.top < tocRect.top) {
            this.$toc.scrollTop = this.$toc.scrollTop - (tocRect.top - rect.top);
          }
        }
        current = children[i].querySelector('ol');
        index++;
        break;
      }      
    }
    
  }
}

function findActiveClause(root, path) {
  var clauses = new ClauseWalker(root);
  var $clause;
  var found = false;
  var path = path || [];
  
  while ($clause = clauses.nextNode()) {
    var rect = $clause.getBoundingClientRect();
    var $header = $clause.children[0];
    var marginTop = parseInt(getComputedStyle($header)["margin-top"]);
    
    if ((rect.top - marginTop) <= 0 && rect.bottom > 0) {
      found = true;
      return findActiveClause($clause, path.concat($clause)) || path;
    }
  }
  
  return path;
}

function ClauseWalker(root) {
  var previous;
  var treeWalker = document.createTreeWalker(
    root,
    NodeFilter.SHOW_ELEMENT,
    {
      acceptNode: function (node) {
        if (previous === node.parentNode) {
          return NodeFilter.FILTER_REJECT;
        } else {
          previous = node;
        }
        if (node.nodeName === 'EMU-CLAUSE' || node.nodeName === 'EMU-INTRO' || node.nodeName === 'EMU-ANNEX') {
          return NodeFilter.FILTER_ACCEPT;
        } else {
          return NodeFilter.FILTER_SKIP;
        }
      }
    },
    false
    );
  
  return treeWalker;
}

Menu.prototype.toggle = function () {
  this.$menu.classList.toggle('active');
}

Menu.prototype.show = function () {
  this.$menu.classList.add('active');
}

Menu.prototype.hide = function () {
  this.$menu.classList.remove('active');
}

Menu.prototype.isVisible = function() {
  return this.$menu.classList.contains('active');
}

Menu.prototype.showPins = function () {
  this.$pins.classList.add('active');
}

Menu.prototype.hidePins = function () {
  this.$pins.classList.remove('active');
}

Menu.prototype.addPinEntry = function (id) {
  var entry = this.search.biblio.byId[id];
  if (!entry) {
    // id was deleted after pin (or something) so remove it
    delete this._pinnedIds[id];
    this.persistPinEntries();
    return;
  }

  if (entry.type === 'clause') {
    var prefix;
    if (entry.number) {
      prefix = entry.number + ' ';
    } else {
      prefix = '';
    }
    this.$pinList.innerHTML += '<li><a href="#' + entry.id + '">' + prefix + entry.titleHTML + '</a></li>';
  } else {
    this.$pinList.innerHTML += '<li><a href="#' + entry.id + '">' + entry.key + '</a></li>';
  }

  if (Object.keys(this._pinnedIds).length === 0) {
    this.showPins();
  }
  this._pinnedIds[id] = true;
  this.persistPinEntries();
}

Menu.prototype.removePinEntry = function (id) {
  var item = this.$pinList.querySelector('a[href="#' + id + '"]').parentNode;
  this.$pinList.removeChild(item);
  delete this._pinnedIds[id];
  if (Object.keys(this._pinnedIds).length === 0) {
    this.hidePins();
  }

  this.persistPinEntries();
}

Menu.prototype.persistPinEntries = function () {
  try {
    if (!window.localStorage) return;
  } catch (e) {
    return;
  }

  localStorage.pinEntries = JSON.stringify(Object.keys(this._pinnedIds));
}

Menu.prototype.loadPinEntries = function () {
  try {
    if (!window.localStorage) return;
  } catch (e) {
    return;
  }
  
  var pinsString = window.localStorage.pinEntries;
  if (!pinsString) return;
  var pins = JSON.parse(pinsString);
  for(var i = 0; i < pins.length; i++) {
    this.addPinEntry(pins[i]);
  }
}

Menu.prototype.togglePinEntry = function (id) {
  if (!id) {
    id = this.$activeClause[this.$activeClause.length - 1].id;
  }

  if (this._pinnedIds[id]) {
    this.removePinEntry(id);
  } else {
    this.addPinEntry(id);
  }
}

Menu.prototype.selectPin = function (num) {
  document.location = this.$pinList.children[num].children[0].href;
}

var menu;
function init() {
  menu = new Menu();
  var $container = document.getElementById('spec-container');
  $container.addEventListener('mouseover', debounce(function (e) {
    Toolbox.activateIfMouseOver(e);
  }));
}

document.addEventListener('DOMContentLoaded', init);

function debounce(fn, opts) {
  opts = opts || {};
  var timeout;
  return function(e) {
    if (opts.stopPropagation) {
      e.stopPropagation();
    }
    var args = arguments;
    if (timeout) {
      clearTimeout(timeout);
    }
    timeout = setTimeout(function() {
      timeout = null;
      fn.apply(this, args);
    }.bind(this), 150);
  }
}

var CLAUSE_NODES = ['EMU-CLAUSE', 'EMU-INTRO', 'EMU-ANNEX'];
function findLocalReferences ($elem) {
  var name = $elem.innerHTML;
  var references = [];

  var parentClause = $elem.parentNode;
  while (parentClause && CLAUSE_NODES.indexOf(parentClause.nodeName) === -1) {
    parentClause = parentClause.parentNode;
  }

  if(!parentClause) return;

  var vars = parentClause.querySelectorAll('var');

  for (var i = 0; i < vars.length; i++) {
    var $var = vars[i];

    if ($var.innerHTML === name) {
      references.push($var);
    }
  }

  return references;
}

function toggleFindLocalReferences($elem) {
  var references = findLocalReferences($elem);
  if ($elem.classList.contains('referenced')) {
    references.forEach(function ($reference) {
      $reference.classList.remove('referenced');
    });
  } else {
    references.forEach(function ($reference) {
      $reference.classList.add('referenced');
    });
  }
}

function installFindLocalReferences () {
  document.addEventListener('click', function (e) {
    if (e.target.nodeName === 'VAR') {
      toggleFindLocalReferences(e.target);
    }
  });
}

document.addEventListener('DOMContentLoaded', installFindLocalReferences);




// The following license applies to the fuzzysearch function
// The MIT License (MIT)
// Copyright © 2015 Nicolas Bevacqua
// Copyright © 2016 Brian Terlson
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:

// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
function fuzzysearch (searchString, haystack, caseInsensitive) {
  var tlen = haystack.length;
  var qlen = searchString.length;
  var chunks = 1;
  var finding = false;
  var prefix = true;
  
  if (qlen > tlen) {
    return false;
  }
  
  if (qlen === tlen) {
    if (searchString === haystack) {
      return { caseMatch: true, chunks: 1, prefix: true };
    } else if (searchString.toLowerCase() === haystack.toLowerCase()) {
      return { caseMatch: false, chunks: 1, prefix: true };
    } else {
      return false;
    }
  }
  
  outer: for (var i = 0, j = 0; i < qlen; i++) {
    var nch = searchString[i];
    while (j < tlen) {
      var targetChar = haystack[j++];
      if (targetChar === nch) {
        finding = true;
        continue outer;
      }
      if (finding) {
        chunks++;
        finding = false;
      }
    }
    
    if (caseInsensitive) { return false }
    
    return fuzzysearch(searchString.toLowerCase(), haystack.toLowerCase(), true);
  }
  
  return { caseMatch: !caseInsensitive, chunks: chunks, prefix: j <= qlen };
}

var Toolbox = {
  init: function () {
    this.$container = document.createElement('div');
    this.$container.classList.add('toolbox');
    this.$permalink = document.createElement('a');
    this.$permalink.textContent = 'Permalink';
    this.$pinLink = document.createElement('a');
    this.$pinLink.textContent = 'Pin';
    this.$pinLink.setAttribute('href', '#');
    this.$pinLink.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      menu.togglePinEntry(this.entry.id);
    }.bind(this));

    this.$refsLink = document.createElement('a');
    this.$refsLink.setAttribute('href', '#');
    this.$refsLink.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      referencePane.showReferencesFor(this.entry);
    }.bind(this));
    this.$container.appendChild(this.$permalink);
    this.$container.appendChild(this.$pinLink);
    this.$container.appendChild(this.$refsLink);
    document.body.appendChild(this.$container);
  },

  activate: function (el, entry, target) {
    if (el === this._activeEl) return;
    this.active = true;
    this.entry = entry;
    this.$container.classList.add('active');
    this.top = el.offsetTop - this.$container.offsetHeight - 10;
    this.left = el.offsetLeft;
    this.$container.setAttribute('style', 'left: ' + this.left + 'px; top: ' + this.top + 'px');
    this.updatePermalink();
    this.updateReferences();
    this._activeEl = el;
    if (this.top < document.body.scrollTop && el === target) {
      // don't scroll unless it's a small thing (< 200px)
      this.$container.scrollIntoView();
    }
  },

  updatePermalink: function () {
    this.$permalink.setAttribute('href', '#' + this.entry.id);
  },

  updateReferences: function () {
    this.$refsLink.textContent = 'References (' + this.entry.referencingIds.length + ')';
  },

  activateIfMouseOver: function (e) {
    var ref = this.findReferenceUnder(e.target);
    if (ref && (!this.active || e.pageY > this._activeEl.offsetTop)) {
      var entry = menu.search.biblio.byId[ref.id];
      this.activate(ref.element, entry, e.target);
    } else if (this.active && ((e.pageY < this.top) || e.pageY > (this._activeEl.offsetTop + this._activeEl.offsetHeight))) {
      this.deactivate();
    }
  },

  findReferenceUnder: function (el) {
    while (el) {
      var parent = el.parentNode;
      if (el.nodeName === 'H1' && parent.nodeName.match(/EMU-CLAUSE|EMU-ANNEX|EMU-INTRO/) && parent.id) {
        return { element: el, id: parent.id };
      } else if (el.nodeName.match(/EMU-(?!CLAUSE|XREF|ANNEX|INTRO)|DFN/) &&
                el.id && el.id[0] !== '_') {
        if (el.nodeName === 'EMU-FIGURE' || el.nodeName === 'EMU-TABLE' || el.nodeName === 'EMU-EXAMPLE') {
          // return the figcaption element
          return { element: el.children[0].children[0], id: el.id };
        } else if (el.nodeName === 'EMU-PRODUCTION') {
          // return the LHS non-terminal element
          return { element: el.children[0], id: el.id };
        } else {
          return { element: el, id: el.id };
        }
      }
      el = parent;
    }
  },

  deactivate: function () {
    this.$container.classList.remove('active');
    this._activeEl = null;
    this.activeElBounds = null;
    this.active = false;
  }
}

var referencePane = {
  init: function() {
    this.$container = document.createElement('div');
    this.$container.setAttribute('id', 'references-pane-container');

    var $spacer = document.createElement('div');
    $spacer.setAttribute('id', 'references-pane-spacer');

    this.$pane = document.createElement('div');
    this.$pane.setAttribute('id', 'references-pane');

    this.$container.appendChild($spacer);
    this.$container.appendChild(this.$pane);

    this.$header = document.createElement('div');
    this.$header.classList.add('menu-pane-header');
    this.$header.textContent = 'References to ';
    this.$headerRefId = document.createElement('a');
    this.$header.appendChild(this.$headerRefId);
    this.$closeButton = document.createElement('span');
    this.$closeButton.setAttribute('id', 'references-pane-close');
    this.$closeButton.addEventListener('click', function (e) {
      this.deactivate();
    }.bind(this));
    this.$header.appendChild(this.$closeButton);

    this.$pane.appendChild(this.$header);
    var tableContainer = document.createElement('div');
    tableContainer.setAttribute('id', 'references-pane-table-container');

    this.$table = document.createElement('table');
    this.$table.setAttribute('id', 'references-pane-table');

    this.$tableBody = this.$table.createTBody();

    tableContainer.appendChild(this.$table);
    this.$pane.appendChild(tableContainer);

    menu.$specContainer.appendChild(this.$container);
  },

  activate: function () {
    this.$container.classList.add('active');
  },

  deactivate: function () {
    this.$container.classList.remove('active');
  },

  showReferencesFor(entry) {
    this.activate();
    var newBody = document.createElement('tbody');
    var previousId;
    var previousCell;
    var dupCount = 0;
    this.$headerRefId.textContent = '#' + entry.id;
    this.$headerRefId.setAttribute('href', '#' + entry.id);
    entry.referencingIds.map(function (id) {
      var target = document.getElementById(id);
      var cid = findParentClauseId(target);
      var clause = menu.search.biblio.byId[cid];
      var dupCount = 0;
      return { id: id, clause: clause }
    }).sort(function (a, b) {
      return sortByClauseNumber(a.clause, b.clause);
    }).forEach(function (record, i) {
      if (previousId === record.clause.id) {
        previousCell.innerHTML += ' (<a href="#' + record.id + '">' + (dupCount + 2) + '</a>)';
        dupCount++;
      } else {
        var row = newBody.insertRow();
        var cell = row.insertCell();
        cell.innerHTML = record.clause.number;
        cell = row.insertCell();
        cell.innerHTML = '<a href="#' + record.id + '">' + record.clause.titleHTML + '</a>';
        previousCell = cell;
        previousId = record.clause.id;
        dupCount = 0;
      }
    }, this);
    this.$table.removeChild(this.$tableBody);
    this.$tableBody = newBody;
    this.$table.appendChild(this.$tableBody);
  }
}
function findParentClauseId(node) {
  while (node && node.nodeName !== 'EMU-CLAUSE' && node.nodeName !== 'EMU-INTRO' && node.nodeName !== 'EMU-ANNEX') {
    node = node.parentNode;
  }
  if (!node) return null;
  return node.getAttribute('id');
}

function sortByClauseNumber(c1, c2) {
  var c1c = c1.number.split('.');
  var c2c = c2.number.split('.');

  for (var i = 0; i < c1c.length; i++) {
    if (i >= c2c.length) {
      return 1;
    }
    
    var c1 = c1c[i];
    var c2 = c2c[i];
    var c1cn = Number(c1);
    var c2cn = Number(c2);

    if (Number.isNaN(c1cn) && Number.isNaN(c2cn)) {
      if (c1 > c2) {
        return 1;
      } else if (c1 < c2) {
        return -1;
      }
    } else if (!Number.isNaN(c1cn) && Number.isNaN(c2cn)) {
      return -1;
    } else if (Number.isNaN(c1cn) && !Number.isNaN(c2cn)) {
      return 1;
    } else if(c1cn > c2cn) {
      return 1;
    } else if (c1cn < c2cn) {
      return -1;
    }
  }

  if (c1c.length === c2c.length) {
    return 0;
  }
  return -1;
}

document.addEventListener('DOMContentLoaded', function () {
  Toolbox.init();
  referencePane.init();
})
var CLAUSE_NODES = ['EMU-CLAUSE', 'EMU-INTRO', 'EMU-ANNEX'];
function findLocalReferences ($elem) {
  var name = $elem.innerHTML;
  var references = [];

  var parentClause = $elem.parentNode;
  while (parentClause && CLAUSE_NODES.indexOf(parentClause.nodeName) === -1) {
    parentClause = parentClause.parentNode;
  }

  if(!parentClause) return;

  var vars = parentClause.querySelectorAll('var');

  for (var i = 0; i < vars.length; i++) {
    var $var = vars[i];

    if ($var.innerHTML === name) {
      references.push($var);
    }
  }

  return references;
}

function toggleFindLocalReferences($elem) {
  var references = findLocalReferences($elem);
  if ($elem.classList.contains('referenced')) {
    references.forEach(function ($reference) {
      $reference.classList.remove('referenced');
    });
  } else {
    references.forEach(function ($reference) {
      $reference.classList.add('referenced');
    });
  }
}

function installFindLocalReferences () {
  document.addEventListener('click', function (e) {
    if (e.target.nodeName === 'VAR') {
      toggleFindLocalReferences(e.target);
    }
  });
}

document.addEventListener('DOMContentLoaded', installFindLocalReferences);
</script><style>body {
  display: flex;
  font-size: 18px;
  line-height: 1.5;
  font-family: Cambria, Palatino Linotype, Palatino, Liberation Serif, serif;
  padding: 0;
  margin: 0;
  color: #111;
}

#spec-container {
  padding: 0 20px;
  flex-grow: 1;
  flex-basis: 66%;
  box-sizing: border-box;
  overflow: hidden;
}

body.oldtoc {
  margin: 0 auto;
}

a {
    text-decoration: none;
    color: #206ca7;
}

a:visited {
  color: #206ca7;
}

a:hover {
    text-decoration: underline;
    color: #239dee;
}


code {
    font-weight: bold;
    font-family: Consolas, Monaco, monospace;
    white-space: pre;
}

pre code {
  font-weight: inherit;
}

pre code.hljs {
  background-color: #fff;
  margin: 0;
  padding: 0;
}

ol.toc {
    list-style: none;
    padding-left: 0;
}

ol.toc ol.toc {
    padding-left: 2ex;
    list-style: none;
}

var {
  color: #2aa198;
  transition: background-color 0.25s ease;
  cursor: pointer;
}

var.referenced {
  background-color: #ffff33;
}

emu-const {
  font-family: sans-serif;
}

emu-val {
  font-weight: bold;
}
emu-alg ol, emu-alg ol ol ol ol {
    list-style-type: decimal;
}

emu-alg ol ol, emu-alg ol ol ol ol ol {
    list-style-type: lower-alpha;
}

emu-alg ol ol ol, ol ol ol ol ol ol {
    list-style-type: lower-roman;
}

emu-eqn {
  display: block;
  margin-left: 4em;
}

emu-eqn.inline {
  display: inline;
  margin: 0;
}

emu-eqn div:first-child {
  margin-left: -2em;
}

emu-note {
    margin: 1em 0;
    color: #666;
    border-left: 5px solid #ccc;
    display: flex;
    flex-direction: row;
}

emu-note > span.note {
    flex-basis: 100px;
    min-width: 100px;
    flex-grow: 0;
    flex-shrink: 1;
    text-transform: uppercase;
    padding-left: 5px;
}

emu-note[type=editor] {
  border-left-color: #faa;
}

emu-note > div.note-contents {
  flex-grow: 1;
  flex-shrink: 1;
}

emu-note > div.note-contents > p:first-child {
  margin-top: 0;
}

emu-note > div.note-contents > p:last-child {
  margin-bottom: 0;
}

emu-figure {
  display: block;
}

emu-example {
  display: block;
  margin: 1em 3em;
}

emu-example figure figcaption {
  margin-top: 0.5em;
  text-align: left;
}

emu-figure figure,
emu-example figure,
emu-table figure {
  display: flex;
  flex-direction: column;
  align-items: center;
}

emu-production {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
    margin-left: 5ex;
}


emu-grammar.inline, emu-production.inline,
emu-grammar.inline emu-production emu-rhs, emu-production.inline emu-rhs {
  display: inline;
}

emu-grammar[collapsed] emu-production, emu-production[collapsed] {
    margin: 0;
}

emu-grammar[collapsed] emu-production emu-rhs, emu-production[collapsed] emu-rhs {
    display: inline;
    padding-left: 1ex;
}

emu-constraints {
    font-size: .75em;
    margin-right: 1ex;
}

emu-gann {
    margin-right: 1ex;
}

emu-gann emu-t:last-child,
emu-gann emu-nt:last-child {
    margin-right: 0;
}

emu-geq {
    margin-left: 1ex;
    font-weight: bold;
}

emu-oneof {
    font-weight: bold;
    margin-left: 1ex;
}

emu-nt {
    display: inline-block;
    font-style: italic;
    white-space: nowrap;
    text-indent: 0;
}

emu-nt a, emu-nt a:visited {
  color: #333;
}

emu-rhs emu-nt {
    margin-right: 1ex;
}

emu-t {
    display: inline-block;
    font-family: monospace;
    font-weight: bold;
    white-space: nowrap;
    text-indent: 0;
}

emu-production emu-t {
    margin-right: 1ex;
}

emu-rhs {
    display: block;
    padding-left: 75px;
    text-indent: -25px;
}

emu-mods {
    font-size: .85em;
    vertical-align: sub;
    font-style: normal;
    font-weight: normal;
}

emu-production[collapsed] emu-mods {
  display: none;
}

emu-params, emu-opt {
  margin-right: 1ex;
  font-family: monospace;
}

emu-params, emu-constraints {
  color: #2aa198;
}

emu-opt {
  color: #b58900;
}

emu-gprose {
    font-size: 0.9em;
    font-family: Helvetica, Arial, sans-serif;
}

h1.shortname {
  color: #f60;
  font-size: 1.5em;
  margin: 0;
}

h1.version {
  color: #f60;
  font-size: 1.5em;
  margin: 0;
}

h1.title {
  margin-top: 0;
  color: #f60;
}

h1.first {
  margin-top: 0;
}

h1, h2, h3, h4, h5, h6 {
    position: relative;
}

h1 .secnum {
  text-decoration: none;
  margin-right: 10px;
}

h1 span.title {
  order: 2;
}


h1 { font-size: 2.67em; margin-top: 2em; margin-bottom: 0; line-height: 1em;}
h2 { font-size: 2em; }
h3 { font-size: 1.56em; }
h4 { font-size: 1.25em; }
h5 { font-size: 1.11em; }
h6 { font-size: 1em; }

h1:hover span.utils {
  display: block;
}

span.utils {
  font-size: 18px;
  line-height: 18px;
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  font-weight: normal;
}

span.utils:before {
    content: "⤷";
    display: inline-block;
    padding: 0 5px;
}

span.utils > * {
  display: inline-block;
  margin-right: 20px;
}

h1 span.utils span.anchor a,
h2 span.utils span.anchor a,
h3 span.utils span.anchor a,
h4 span.utils span.anchor a,
h5 span.utils span.anchor a,
h6 span.utils span.anchor a {
  text-decoration: none;
  font-variant: small-caps;
}

h1 span.utils span.anchor a:hover,
h2 span.utils span.anchor a:hover,
h3 span.utils span.anchor a:hover,
h4 span.utils span.anchor a:hover,
h5 span.utils span.anchor a:hover,
h6 span.utils span.anchor a:hover {
  color: #333;
}

emu-intro h1, emu-clause h1, emu-annex h1 { font-size: 2em; }
emu-intro h2, emu-clause h2, emu-annex h2 { font-size: 1.56em; }
emu-intro h3, emu-clause h3, emu-annex h3 { font-size: 1.25em; }
emu-intro h4, emu-clause h4, emu-annex h4 { font-size: 1.11em; }
emu-intro h5, emu-clause h5, emu-annex h5 { font-size: 1em; }
emu-intro h6, emu-clause h6, emu-annex h6 { font-size: 0.9em; }
emu-intro emu-intro h1, emu-clause emu-clause h1, emu-annex emu-annex h1 { font-size: 1.56em; }
emu-intro emu-intro h2, emu-clause emu-clause h2, emu-annex emu-annex h2 { font-size: 1.25em; }
emu-intro emu-intro h3, emu-clause emu-clause h3, emu-annex emu-annex h3 { font-size: 1.11em; }
emu-intro emu-intro h4, emu-clause emu-clause h4, emu-annex emu-annex h4 { font-size: 1em; }
emu-intro emu-intro h5, emu-clause emu-clause h5, emu-annex emu-annex h5 { font-size: 0.9em; }
emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex h1 { font-size: 1.25em; }
emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex h2 { font-size: 1.11em; }
emu-intro emu-intro emu-intro h3, emu-clause emu-clause emu-clause h3, emu-annex emu-annex emu-annex h3 { font-size: 1em; }
emu-intro emu-intro emu-intro h4, emu-clause emu-clause emu-clause h4, emu-annex emu-annex emu-annex h4 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex h1 { font-size: 1.11em; }
emu-intro emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex emu-annex h2 { font-size: 1em; }
emu-intro emu-intro emu-intro emu-intro h3, emu-clause emu-clause emu-clause emu-clause h3, emu-annex emu-annex emu-annex emu-annex h3 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex emu-annex h1 { font-size: 1em; }
emu-intro emu-intro emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex emu-annex emu-annex h2 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex emu-annex emu-annex h1 { font-size: 0.9em }

emu-clause, emu-intro, emu-annex {
    display: block;
}

/* Figures and tables */
figure { display: block; margin: 1em 0 3em 0; }
figure object { display: block; margin: 0 auto; }
figure table.real-table { margin: 0 auto; }
figure figcaption {
    display: block;
    color: #555555;
    font-weight: bold;
    text-align: center;
}

emu-table table {
  margin: 0 auto;
}

emu-table table, table.real-table {
    border-collapse: collapse;
}

emu-table td, emu-table th, table.real-table td, table.real-table th {
    border: 1px solid black;
    padding: 0.4em;
    vertical-align: baseline;
}
emu-table th, emu-table thead td, table.real-table th {
    background-color: #eeeeee;
}

/* Note: the left content edges of table.lightweight-table >tbody >tr >td
   and div.display line up. */
table.lightweight-table {
    border-collapse: collapse;
    margin: 0 0 0 1.5em;
}
table.lightweight-table td, table.lightweight-table th {
    border: none;
    padding: 0 0.5em;
    vertical-align: baseline;
}

/* diff styles */
ins {
    background-color: #e0f8e0;
    text-decoration: none;
    border-bottom: 1px solid #396;
}

del {
    background-color: #fee;
}

ins.block, del.block,
emu-production > ins, emu-production > del,
emu-grammar > ins, emu-grammar > del {
  display: block;
}

/* Menu Styles */
#menu-toggle {
  font-size: 2em;

  position: fixed;
  top: 0;
  left: 0;
  width: 1.5em;
  height: 1.5em;
  z-index: 3;
  visibility: hidden;
  color: #1567a2;
  background-color: #fff;

  line-height: 1.5em;
  text-align: center;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;;

  cursor: pointer;
}

#menu {
  display: flex;
  flex-direction: column;
  width: 33%; height: 100vh;
  max-width: 500px;
  box-sizing: border-box;
  background-color: #ddd;
  overflow: hidden;
  transition: opacity 0.1s linear;
  padding: 0 5px;
  position: fixed;
  left: 0; top: 0;
  border-right: 2px solid #bbb;

  z-index: 2;
}

#menu-spacer {
  flex-basis: 33%;
  max-width: 500px;
  flex-grow: 0;
  flex-shrink: 0;
}

#menu a {
  color: #1567a2;
}

#menu.active {
  display: flex;
  opacity: 1;
  z-index: 2;
}

#menu-pins {
  flex-grow: 1;
  display: none;
}

#menu-pins.active {
  display: block;
}

#menu-pins-list {
  margin: 0;
  padding: 0;
  counter-reset: pins-counter;
}

#menu-pins-list > li:before {
  content: counter(pins-counter);
  counter-increment: pins-counter;
  display: inline-block;
  width: 25px;
  text-align: center;
  border: 1px solid #bbb;
  padding: 2px;
  margin: 4px;
  box-sizing: border-box;
  line-height: 1em;
  background-color: #ccc;
  border-radius: 4px;
}
#menu-toc > ol {
  padding: 0;
  flex-grow: 1;
}

#menu-toc > ol li {
  padding: 0;
}

#menu-toc > ol , #menu-toc > ol ol {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

#menu-toc > ol ol {
  padding-left: 0.75em;
}

#menu-toc li {
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}

#menu-toc .item-toggle {
  display: inline-block;
  transform: rotate(-45deg) translate(-5px, -5px);
  transition: transform 0.1s ease;
  text-align: center;
  width: 20px;

  color: #aab;

  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;;

  cursor: pointer;
}

#menu-toc .item-toggle-none {
  display: inline-block;
  width: 20px;
}

#menu-toc li.active > .item-toggle {
  transform: rotate(45deg) translate(-5px, -5px);
}

#menu-toc li > ol {
  display: none;
}

#menu-toc li.active > ol {
  display: block;
}

#menu-toc li.revealed > a {
  background-color: #bbb;
  font-weight: bold;
  /*
  background-color: #222;
  color: #c6d8e4;
  */
}

#menu-toc li.revealed-leaf> a {
  color: #206ca7;
  /*
  background-color: #222;
  color: #c6d8e4;
  */
}

#menu-toc li.revealed > .item-toggle {
  transform: rotate(45deg) translate(-5px, -5px);
}

#menu-toc li.revealed > ol {
  display: block;
}

#menu-toc li > a {
  padding: 2px 5px;
}

#menu > * {
  margin-bottom: 5px;
}

.menu-pane-header {
  padding: 0 5px;
  text-transform: uppercase;
  background-color: #aaa;
  color: #335;
  font-weight: bold;
  letter-spacing: 2px;
  flex-grow: 0;
  flex-shrink: 0;
  font-size: 0.8em;
}

#menu-toc {
  display: flex;
  flex-direction: column;
  width: 100%;
  overflow: hidden;
  flex-grow: 1;
}

#menu-toc ol.toc {
  overflow-x: hidden;
  overflow-y: auto;
}

#menu-search {
  position: relative;
  flex-grow: 0;
  flex-shrink: 0;
  width: 100%;
  
  display: flex;
  flex-direction: column;
  
  max-height: 300px;
}

#menu-trace-list {
  display: none;
}

#menu-search-box {
  box-sizing: border-box;
  display: block;
  width: 100%;
  margin: 5px 0 0 0;
  font-size: 1em;
  padding: 2px;
  background-color: #bbb;
  border: 1px solid #999;
}

#menu-search-results {
  overflow-x: hidden;
  overflow-y: auto;
}

li.menu-search-result-clause:before {
    content: 'clause';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%;
}
li.menu-search-result-op:before {
    content: 'op';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%;
}

li.menu-search-result-prod:before {
    content: 'prod';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%
}


li.menu-search-result-term:before {
    content: 'term';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%
}

#menu-search-results ul {
  padding: 0 5px;
  margin: 0;
}

#menu-search-results li {
  white-space: nowrap;
  text-overflow: ellipsis;
}


#menu-trace-list {
  counter-reset: item;
  margin: 0 0 0 20px;
  padding: 0;
}
#menu-trace-list li {
  display: block;
  white-space: nowrap;
}

#menu-trace-list li .secnum:after {
  content: " ";
}
#menu-trace-list li:before {
    content: counter(item) " ";
    background-color: #222;
    counter-increment: item;
    color: #999;
    width: 20px;
    height: 20px;
    line-height: 20px;
    display: inline-block;
    text-align: center;
    margin: 2px 4px 2px 0;
}

@media (max-width: 1000px) {
  body {
    margin: 0;
    display: block;
  }

  #menu {
    display: none;
    padding-top: 3em;
    width: 450px;
  }

  #menu.active {
    position: fixed;
    height: 100%;
    left: 0;
    top: 0;
    right: 300px;
  }

  #menu-toggle {
    visibility: visible;
  }

  #spec-container {
    padding: 0 5px;
  }

  #references-pane-spacer {
    display: none;
  }
}

@media only screen and (max-width: 800px) {
  #menu {
    width: 100%;
  }

  h1 .secnum:empty {
    margin: 0; padding: 0;
  }
}


/* Toolbox */
.toolbox {
	position: absolute;
	background: #ddd;
	border: 1px solid #aaa;
  display: none;
  color: #eee;
  padding: 5px;
  border-radius: 3px;
}

.toolbox.active {
  display: inline-block;
}

.toolbox a {
  text-decoration: none;
  padding: 0 5px;
}

.toolbox a:hover {
  text-decoration: underline;
}

.toolbox:after, .toolbox:before {
	top: 100%;
	left: 15px;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

.toolbox:after {
	border-color: rgba(0, 0, 0, 0);
	border-top-color: #ddd;
	border-width: 10px;
	margin-left: -10px;
}
.toolbox:before {
	border-color: rgba(204, 204, 204, 0);
	border-top-color: #aaa;
	border-width: 12px;
	margin-left: -12px;
}

#references-pane-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 250px;
  display: none;
  background-color: #ddd;
  z-index: 1;
}

#references-pane-table-container {
  overflow-x: hidden;
  overflow-y: auto;
}

#references-pane-spacer {
  flex-basis: 33%;
  max-width: 500px;
}

#references-pane {
  flex-grow: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

#references-pane-container.active {
  display: flex;
}

#references-pane-close:after {
  content: '✖';
  float: right;
  cursor: pointer;
}

#references-pane table tr td:first-child {
  text-align: right;
  padding-right: 5px;
}
</style></head><body><div id="menu-toggle">☰</div><div id="menu-spacer"></div><div id="menu"><div id="menu-search"><input type="text" id="menu-search-box" placeholder="Search..."><div id="menu-search-results" class="inactive"></div></div><div id="menu-pins"><div class="menu-pane-header">Pins</div><ul id="menu-pins-list"></ul></div><div class="menu-pane-header">Table of Contents</div><div id="menu-toc"><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-introduction" title="Introduction"><span class="secnum">1</span> Introduction</a></li><li><span class="item-toggle-none"></span><a href="#sec-patternsyntax" title="Pattern Syntax"><span class="secnum">2</span> Pattern Syntax</a></li><li><span class="item-toggle">◢</span><a href="#sec-patternsemantics" title="Pattern Semantics"><span class="secnum">3</span> Pattern Semantics</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-pattern" title="Pattern"><span class="secnum">3.1</span> Pattern</a></li><li><span class="item-toggle-none"></span><a href="#sec-disjunction" title="Disjunction"><span class="secnum">3.2</span> Disjunction</a></li><li><span class="item-toggle-none"></span><a href="#sec-alternative" title="Alternative"><span class="secnum">3.3</span> Alternative</a></li><li><span class="item-toggle">◢</span><a href="#sec-term" title="Term"><span class="secnum">3.4</span> Term</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-runtime-semantics-repeatmatcher-abstract-operation" title="Runtime Semantics: RepeatMatcher Abstract Operation"><span class="secnum">3.4.1</span> RS: RepeatMatcher Abstract Operation</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-assertion" title="Assertion"><span class="secnum">3.5</span> Assertion</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-runtime-semantics-wordcharacters-abstract-operation" title="Runtime Semantics: WordCharacters Abstract Operation"><span class="secnum">3.5.1</span> RS: WordCharacters Abstract Operation</a></li><li><span class="item-toggle-none"></span><a href="#sec-runtime-semantics-iswordchar-abstract-operation" title="Runtime Semantics: IsWordChar Abstract Operation"><span class="secnum">3.5.2</span> RS: IsWordChar Abstract Operation</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-atom" title="Atom"><span class="secnum">3.6</span> Atom</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation" title="Runtime Semantics: CharacterSetMatcher Abstract Operation"><span class="secnum">3.6.1</span> RS: CharacterSetMatcher Abstract Operation</a></li><li><span class="item-toggle-none"></span><a href="#sec-runtime-semantics-canonicalize-ch" title="Runtime Semantics: Canonicalize ( ch )"><span class="secnum">3.6.2</span> RS: Canonicalize ( <var>ch</var> )</a></li></ol></li><li><span class="item-toggle-none"></span><a href="#sec-atomescape" title="AtomEscape"><span class="secnum">3.7</span> AtomEscape</a></li></ol></li></ol></div></div><div id="spec-container"><h1 class="version first">Stage 3 Draft / March 22, 2017</h1><h1 class="title">RegExp Lookbehind Assertions</h1>
<script src="ecmarkup.js" defer=""></script>
<link rel="stylesheet" href="ecmarkup.css">

<emu-clause id="sec-introduction">
  <h1><span class="secnum">1</span>Introduction</h1>
  <emu-import href="./introduction.html"><p>Lookarounds are zero-width assertions that match a string without consuming anything. ECMAScript has lookahead
assertions that does this in forward direction, but the language is missing a way to do this backward which the
lookbehind assertions provide. With lookbehind assertions, one can make sure that a pattern is or isn't preceded by
another, e.g. matching a dollar amount without capturing the dollar sign.</p>

<p>See  <a href="https://github.com/littledan/proposal-regexp-lookbehind">the proposal repository</a> for background material and discussion.</p>
</emu-import>
</emu-clause>

<emu-clause id="sec-patternsyntax">
  <h1><span class="secnum">2</span>Pattern Syntax</h1>
  <emu-import href="./syntax.html"><emu-grammar><emu-production name="Pattern" params="U" type="lexical" id="prod-Pattern">
    <emu-nt params="U"><a href="#prod-Pattern">Pattern</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="a0a70437"><emu-nt params="?U" id="_ref_19"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="Disjunction" params="U" type="lexical" id="prod-Disjunction">
    <emu-nt params="U"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="4b950b56"><emu-nt params="?U" id="_ref_20"><a href="#prod-Alternative">Alternative</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="cd9683b1"><emu-nt params="?U" id="_ref_21"><a href="#prod-Alternative">Alternative</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>|</emu-t><emu-nt params="?U" id="_ref_22"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="Alternative" params="U" type="lexical" id="prod-Alternative">
    <emu-nt params="U"><a href="#prod-Alternative">Alternative</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="37b9c04c"><emu-gann>[empty]</emu-gann></emu-rhs>
    <emu-rhs a="57d30f89"><emu-nt params="?U" id="_ref_23"><a href="#prod-Alternative">Alternative</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt params="?U" id="_ref_24"><a href="#prod-Term">Term</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="Term" params="U" type="lexical" id="prod-Term">
    <emu-nt params="U"><a href="#prod-Term">Term</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="cb49b8ab"><emu-nt params="?U" id="_ref_25"><a href="#prod-Assertion">Assertion</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="e670ba7b"><emu-nt params="?U" id="_ref_26"><a href="#prod-Atom">Atom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="5e2e9728"><emu-nt params="?U" id="_ref_27"><a href="#prod-Atom">Atom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt id="_ref_28"><a href="#prod-Quantifier">Quantifier</a></emu-nt></emu-rhs>
</emu-production>
<emu-production name="Assertion" params="U" type="lexical" id="prod-Assertion">
    <emu-nt params="U"><a href="#prod-Assertion">Assertion</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="e5878811"><emu-t>^</emu-t></emu-rhs>
    <emu-rhs a="1262cc92"><emu-t>$</emu-t></emu-rhs>
    <emu-rhs a="1e228da5"><emu-t>\</emu-t><emu-t>b</emu-t></emu-rhs>
    <emu-rhs a="a5dc97fa"><emu-t>\</emu-t><emu-t>B</emu-t></emu-rhs>
    <emu-rhs a="ff1cd060"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>=</emu-t><emu-nt params="?U" id="_ref_29"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs>
    <emu-rhs a="61c3834c"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>!</emu-t><emu-nt params="?U" id="_ref_30"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs><ins class="block">
    <emu-rhs a="198b256d"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>&lt;=</emu-t><emu-nt params="?U" id="_ref_31"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs></ins>
    <ins class="block"><emu-rhs a="32fa3748"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>&lt;!</emu-t><emu-nt params="?U" id="_ref_32"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs>
</ins></emu-production>
<emu-production name="Quantifier" type="lexical" id="prod-Quantifier">
    <emu-nt><a href="#prod-Quantifier">Quantifier</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="0e588d23"><emu-nt id="_ref_33"><a href="#prod-QuantifierPrefix">QuantifierPrefix</a></emu-nt></emu-rhs>
    <emu-rhs a="0b0b5479"><emu-nt id="_ref_34"><a href="#prod-QuantifierPrefix">QuantifierPrefix</a></emu-nt><emu-t>?</emu-t></emu-rhs>
</emu-production>
<emu-production name="QuantifierPrefix" type="lexical" id="prod-QuantifierPrefix">
    <emu-nt><a href="#prod-QuantifierPrefix">QuantifierPrefix</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="b01e734d"><emu-t>*</emu-t></emu-rhs>
    <emu-rhs a="e0370b05"><emu-t>+</emu-t></emu-rhs>
    <emu-rhs a="232d7160"><emu-t>?</emu-t></emu-rhs>
    <emu-rhs a="68a2b74e"><emu-t>{</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigits">DecimalDigits</a></emu-nt><emu-t>}</emu-t></emu-rhs>
    <emu-rhs a="82e97391"><emu-t>{</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigits">DecimalDigits</a></emu-nt><emu-t>,</emu-t><emu-t>}</emu-t></emu-rhs>
    <emu-rhs a="f47829c0"><emu-t>{</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigits">DecimalDigits</a></emu-nt><emu-t>,</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigits">DecimalDigits</a></emu-nt><emu-t>}</emu-t></emu-rhs>
</emu-production>
<emu-production name="Atom" params="U" type="lexical" id="prod-Atom">
    <emu-nt params="U"><a href="#prod-Atom">Atom</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="beff52c4"><emu-nt id="_ref_35"><a href="#prod-PatternCharacter">PatternCharacter</a></emu-nt></emu-rhs>
    <emu-rhs a="9658e473"><emu-t>.</emu-t></emu-rhs>
    <emu-rhs a="360729b9"><emu-t>\</emu-t><emu-nt params="?U" id="_ref_36"><a href="#prod-AtomEscape">AtomEscape</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="72a5dc04"><emu-nt params="?U" id="_ref_37"><a href="#prod-CharacterClass">CharacterClass</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="3cf132bc"><emu-t>(</emu-t><emu-nt params="?U" id="_ref_38"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs>
    <emu-rhs a="a3359f62"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>:</emu-t><emu-nt params="?U" id="_ref_39"><a href="#prod-Disjunction">Disjunction</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production>
<emu-production name="SyntaxCharacter" type="lexical" oneof="" id="prod-SyntaxCharacter">
    <emu-nt><a href="#prod-SyntaxCharacter">SyntaxCharacter</a></emu-nt><emu-geq>::</emu-geq><emu-oneof>one of</emu-oneof><emu-rhs><emu-t>^</emu-t><emu-t>$</emu-t><emu-t>\</emu-t><emu-t>.</emu-t><emu-t>*</emu-t><emu-t>+</emu-t><emu-t>?</emu-t><emu-t>(</emu-t><emu-t>)</emu-t><emu-t>[</emu-t><emu-t>]</emu-t><emu-t>{</emu-t><emu-t>}</emu-t><emu-t>|</emu-t></emu-rhs>
</emu-production>
<emu-production name="PatternCharacter" type="lexical" id="prod-PatternCharacter">
    <emu-nt><a href="#prod-PatternCharacter">PatternCharacter</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="b94d4da1"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-SourceCharacter">SourceCharacter</a></emu-nt><emu-gmod>but not <emu-nt id="_ref_40"><a href="#prod-SyntaxCharacter">SyntaxCharacter</a></emu-nt></emu-gmod></emu-rhs>
</emu-production>
<emu-production name="AtomEscape" params="U" type="lexical" id="prod-AtomEscape">
    <emu-nt params="U"><a href="#prod-AtomEscape">AtomEscape</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="7ebff96c"><emu-nt id="_ref_41"><a href="#prod-DecimalEscape">DecimalEscape</a></emu-nt></emu-rhs>
    <emu-rhs a="6f05bee4"><emu-nt id="_ref_42"><a href="#prod-CharacterClassEscape">CharacterClassEscape</a></emu-nt></emu-rhs>
    <emu-rhs a="4b80816a"><emu-nt params="?U" id="_ref_43"><a href="#prod-CharacterEscape">CharacterEscape</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="CharacterEscape" params="U" type="lexical" id="prod-CharacterEscape">
    <emu-nt params="U"><a href="#prod-CharacterEscape">CharacterEscape</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="f88e7170"><emu-nt id="_ref_44"><a href="#prod-ControlEscape">ControlEscape</a></emu-nt></emu-rhs>
    <emu-rhs a="a14dae7e"><emu-t>c</emu-t><emu-nt id="_ref_45"><a href="#prod-ControlLetter">ControlLetter</a></emu-nt></emu-rhs>
    <emu-rhs a="6964a19d"><emu-t>0</emu-t><emu-gann>[lookahead ∉ <emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigit">DecimalDigit</a></emu-nt>]</emu-gann></emu-rhs>
    <emu-rhs a="a8071b85"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-HexEscapeSequence">HexEscapeSequence</a></emu-nt></emu-rhs>
    <emu-rhs a="2649a73f"><emu-nt params="?U" id="_ref_46"><a href="#prod-RegExpUnicodeEscapeSequence">RegExpUnicodeEscapeSequence</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="2037e8bf"><emu-nt params="?U" id="_ref_47"><a href="#prod-IdentityEscape">IdentityEscape</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="ControlEscape" type="lexical" oneof="" id="prod-ControlEscape">
    <emu-nt><a href="#prod-ControlEscape">ControlEscape</a></emu-nt><emu-geq>::</emu-geq><emu-oneof>one of</emu-oneof><emu-rhs><emu-t>f</emu-t><emu-t>n</emu-t><emu-t>r</emu-t><emu-t>t</emu-t><emu-t>v</emu-t></emu-rhs>
</emu-production>
<emu-production name="ControlLetter" type="lexical" oneof="" id="prod-ControlLetter">
    <emu-nt><a href="#prod-ControlLetter">ControlLetter</a></emu-nt><emu-geq>::</emu-geq><emu-oneof>one of</emu-oneof><emu-rhs><emu-t>a</emu-t><emu-t>b</emu-t><emu-t>c</emu-t><emu-t>d</emu-t><emu-t>e</emu-t><emu-t>f</emu-t><emu-t>g</emu-t><emu-t>h</emu-t><emu-t>i</emu-t><emu-t>j</emu-t><emu-t>k</emu-t><emu-t>l</emu-t><emu-t>m</emu-t><emu-t>n</emu-t><emu-t>o</emu-t><emu-t>p</emu-t><emu-t>q</emu-t><emu-t>r</emu-t><emu-t>s</emu-t><emu-t>t</emu-t><emu-t>u</emu-t><emu-t>v</emu-t><emu-t>w</emu-t><emu-t>x</emu-t><emu-t>y</emu-t><emu-t>z</emu-t><emu-t>A</emu-t><emu-t>B</emu-t><emu-t>C</emu-t><emu-t>D</emu-t><emu-t>E</emu-t><emu-t>F</emu-t><emu-t>G</emu-t><emu-t>H</emu-t><emu-t>I</emu-t><emu-t>J</emu-t><emu-t>K</emu-t><emu-t>L</emu-t><emu-t>M</emu-t><emu-t>N</emu-t><emu-t>O</emu-t><emu-t>P</emu-t><emu-t>Q</emu-t><emu-t>R</emu-t><emu-t>S</emu-t><emu-t>T</emu-t><emu-t>U</emu-t><emu-t>V</emu-t><emu-t>W</emu-t><emu-t>X</emu-t><emu-t>Y</emu-t><emu-t>Z</emu-t></emu-rhs>
</emu-production>
<emu-production name="RegExpUnicodeEscapeSequence" params="U" type="lexical" id="prod-RegExpUnicodeEscapeSequence">
    <emu-nt params="U"><a href="#prod-RegExpUnicodeEscapeSequence">RegExpUnicodeEscapeSequence</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="3d311810" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>u</emu-t><emu-nt id="_ref_48"><a href="#prod-LeadSurrogate">LeadSurrogate</a></emu-nt><emu-t>\u</emu-t><emu-nt id="_ref_49"><a href="#prod-TrailSurrogate">TrailSurrogate</a></emu-nt></emu-rhs>
    <emu-rhs a="eb0da713" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>u</emu-t><emu-nt id="_ref_50"><a href="#prod-LeadSurrogate">LeadSurrogate</a></emu-nt></emu-rhs>
    <emu-rhs a="d469a292" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>u</emu-t><emu-nt id="_ref_51"><a href="#prod-TrailSurrogate">TrailSurrogate</a></emu-nt></emu-rhs>
    <emu-rhs a="816e2987" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>u</emu-t><emu-nt id="_ref_52"><a href="#prod-NonSurrogate">NonSurrogate</a></emu-nt></emu-rhs>
    <emu-rhs a="4e7dd512" constraints="~U"><emu-constraints>[~U]</emu-constraints><emu-t>u</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt></emu-rhs>
    <emu-rhs a="b837450f" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>u{</emu-t><emu-nt><a href="https://tc39.github.io/ecma262/#prod-HexDigits">HexDigits</a></emu-nt><emu-t>}</emu-t></emu-rhs>
</emu-production></emu-grammar>
<p>Each <code>\u</code> <emu-nt id="_ref_53"><a href="#prod-TrailSurrogate">TrailSurrogate</a></emu-nt> for which the choice of associated <code>u</code> <emu-nt id="_ref_54"><a href="#prod-LeadSurrogate">LeadSurrogate</a></emu-nt> is ambiguous shall be associated with the nearest possible <code>u</code> <emu-nt id="_ref_55"><a href="#prod-LeadSurrogate">LeadSurrogate</a></emu-nt> that would otherwise have no corresponding <code>\u</code> <emu-nt id="_ref_56"><a href="#prod-TrailSurrogate">TrailSurrogate</a></emu-nt>.</p>
<emu-grammar><emu-production name="LeadSurrogate" type="lexical" id="prod-LeadSurrogate">
    <emu-nt><a href="#prod-LeadSurrogate">LeadSurrogate</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="b4266993"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt><emu-gmod>but only if the SV of <emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt> is in the inclusive range 0xD800 to 0xDBFF</emu-gmod></emu-rhs>
</emu-production>
<emu-production name="TrailSurrogate" type="lexical" id="prod-TrailSurrogate">
    <emu-nt><a href="#prod-TrailSurrogate">TrailSurrogate</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="134361fc"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt><emu-gmod>but only if the SV of <emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt> is in the inclusive range 0xDC00 to 0xDFFF</emu-gmod></emu-rhs>
</emu-production>
<emu-production name="NonSurrogate" type="lexical" id="prod-NonSurrogate">
    <emu-nt><a href="#prod-NonSurrogate">NonSurrogate</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="de3cc0ae"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt><emu-gmod>but only if the SV of <emu-nt><a href="https://tc39.github.io/ecma262/#prod-Hex4Digits">Hex4Digits</a></emu-nt> is not in the inclusive range 0xD800 to 0xDFFF</emu-gmod></emu-rhs>
</emu-production>
<emu-production name="IdentityEscape" params="U" type="lexical" id="prod-IdentityEscape">
    <emu-nt params="U"><a href="#prod-IdentityEscape">IdentityEscape</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="930458ac" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-nt id="_ref_57"><a href="#prod-SyntaxCharacter">SyntaxCharacter</a></emu-nt></emu-rhs>
    <emu-rhs a="d4a820cc" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>/</emu-t></emu-rhs>
    <emu-rhs a="3274530b" constraints="~U"><emu-constraints>[~U]</emu-constraints><emu-nt><a href="https://tc39.github.io/ecma262/#prod-SourceCharacter">SourceCharacter</a></emu-nt><emu-gmod>but not <emu-nt><a href="https://tc39.github.io/ecma262/#prod-UnicodeIDContinue">UnicodeIDContinue</a></emu-nt></emu-gmod></emu-rhs>
</emu-production>
<emu-production name="DecimalEscape" type="lexical" id="prod-DecimalEscape">
    <emu-nt><a href="#prod-DecimalEscape">DecimalEscape</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="627951dd"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-NonZeroDigit">NonZeroDigit</a></emu-nt><emu-nt optional=""><a href="https://tc39.github.io/ecma262/#prod-DecimalDigits">DecimalDigits</a><emu-mods><emu-opt>opt</emu-opt></emu-mods></emu-nt><emu-gann>[lookahead ∉ <emu-nt><a href="https://tc39.github.io/ecma262/#prod-DecimalDigit">DecimalDigit</a></emu-nt>]</emu-gann></emu-rhs>
</emu-production>
<emu-production name="CharacterClassEscape" type="lexical" oneof="" id="prod-CharacterClassEscape">
    <emu-nt><a href="#prod-CharacterClassEscape">CharacterClassEscape</a></emu-nt><emu-geq>::</emu-geq><emu-oneof>one of</emu-oneof><emu-rhs><emu-t>d</emu-t><emu-t>D</emu-t><emu-t>s</emu-t><emu-t>S</emu-t><emu-t>w</emu-t><emu-t>W</emu-t></emu-rhs>
</emu-production>
<emu-production name="CharacterClass" params="U" type="lexical" id="prod-CharacterClass">
    <emu-nt params="U"><a href="#prod-CharacterClass">CharacterClass</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="4acdd45f"><emu-t>[</emu-t><emu-gann>[lookahead ∉ { <emu-t>^</emu-t> }]</emu-gann><emu-nt params="?U" id="_ref_58"><a href="#prod-ClassRanges">ClassRanges</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>]</emu-t></emu-rhs>
    <emu-rhs a="93d354c0"><emu-t>[</emu-t><emu-t>^</emu-t><emu-nt params="?U" id="_ref_59"><a href="#prod-ClassRanges">ClassRanges</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>]</emu-t></emu-rhs>
</emu-production>
<emu-production name="ClassRanges" params="U" type="lexical" id="prod-ClassRanges">
    <emu-nt params="U"><a href="#prod-ClassRanges">ClassRanges</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="37b9c04c"><emu-gann>[empty]</emu-gann></emu-rhs>
    <emu-rhs a="43c27130"><emu-nt params="?U" id="_ref_60"><a href="#prod-NonemptyClassRanges">NonemptyClassRanges</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="NonemptyClassRanges" params="U" type="lexical" id="prod-NonemptyClassRanges">
    <emu-nt params="U"><a href="#prod-NonemptyClassRanges">NonemptyClassRanges</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="cdf200f3"><emu-nt params="?U" id="_ref_61"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="4a76f2ec"><emu-nt params="?U" id="_ref_62"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt params="?U" id="_ref_63"><a href="#prod-NonemptyClassRangesNoDash">NonemptyClassRangesNoDash</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="63fd2e03"><emu-nt params="?U" id="_ref_64"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>-</emu-t><emu-nt params="?U" id="_ref_65"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt params="?U" id="_ref_66"><a href="#prod-ClassRanges">ClassRanges</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="NonemptyClassRangesNoDash" params="U" type="lexical" id="prod-NonemptyClassRangesNoDash">
    <emu-nt params="U"><a href="#prod-NonemptyClassRangesNoDash">NonemptyClassRangesNoDash</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="cdf200f3"><emu-nt params="?U" id="_ref_67"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="2d1a8609"><emu-nt params="?U" id="_ref_68"><a href="#prod-ClassAtomNoDash">ClassAtomNoDash</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt params="?U" id="_ref_69"><a href="#prod-NonemptyClassRangesNoDash">NonemptyClassRangesNoDash</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
    <emu-rhs a="b61280d4"><emu-nt params="?U" id="_ref_70"><a href="#prod-ClassAtomNoDash">ClassAtomNoDash</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-t>-</emu-t><emu-nt params="?U" id="_ref_71"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt><emu-nt params="?U" id="_ref_72"><a href="#prod-ClassRanges">ClassRanges</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="ClassAtom" params="U" type="lexical" id="prod-ClassAtom">
    <emu-nt params="U"><a href="#prod-ClassAtom">ClassAtom</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="6f24a587"><emu-t>-</emu-t></emu-rhs>
    <emu-rhs a="714140ac"><emu-nt params="?U" id="_ref_73"><a href="#prod-ClassAtomNoDash">ClassAtomNoDash</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="ClassAtomNoDash" params="U" type="lexical" id="prod-ClassAtomNoDash">
    <emu-nt params="U"><a href="#prod-ClassAtomNoDash">ClassAtomNoDash</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="ecde6e28"><emu-nt><a href="https://tc39.github.io/ecma262/#prod-SourceCharacter">SourceCharacter</a></emu-nt><emu-gmod>but not one of <emu-t>\</emu-t> or <emu-t>]</emu-t> or <emu-t>-</emu-t></emu-gmod></emu-rhs>
    <emu-rhs a="379e2483"><emu-t>\</emu-t><emu-nt params="?U" id="_ref_74"><a href="#prod-ClassEscape">ClassEscape</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production>
<emu-production name="ClassEscape" params="U" type="lexical" id="prod-ClassEscape">
    <emu-nt params="U"><a href="#prod-ClassEscape">ClassEscape</a><emu-mods><emu-params>[U]</emu-params></emu-mods></emu-nt><emu-geq>::</emu-geq><emu-rhs a="0185ce89"><emu-t>b</emu-t></emu-rhs>
    <emu-rhs a="b14e06ba" constraints="+U"><emu-constraints>[+U]</emu-constraints><emu-t>-</emu-t></emu-rhs>
    <emu-rhs a="6f05bee4"><emu-nt id="_ref_75"><a href="#prod-CharacterClassEscape">CharacterClassEscape</a></emu-nt></emu-rhs>
    <emu-rhs a="4b80816a"><emu-nt params="?U" id="_ref_76"><a href="#prod-CharacterEscape">CharacterEscape</a><emu-mods><emu-params>[?U]</emu-params></emu-mods></emu-nt></emu-rhs>
</emu-production></emu-grammar>
</emu-import>
</emu-clause>

<emu-clause id="sec-patternsemantics">
  <h1><span class="secnum">3</span>Pattern Semantics</h1>
  <emu-import href="./semantics.html"><emu-clause id="sec-pattern">
  <h1><span class="secnum">3.1</span>Pattern</h1>
  <p>The production  <emu-grammar><emu-production name="Pattern" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Pattern">Pattern</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="79a5bbd0"><emu-nt id="_ref_77"><a href="#prod-Disjunction">Disjunction</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_78"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with +1 as its <var>direction</var> argument</ins> to obtain a Matcher <var>m</var>.</li><li>Return an internal closure that takes two arguments, a String <var>str</var> and an integer <var>index</var>, and performs the following steps:<ol><li>Assert: <var>index</var> ≤ the number of elements in <var>str</var>.</li><li>If <var>Unicode</var> is <emu-val>true</emu-val>, let <var>Input</var> be a <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> consisting of the sequence of code points of <var>str</var> interpreted as a UTF-16 encoded (<emu-xref href="#sec-ecmascript-language-types-string-type"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-language-types-string-type">6.1.4</a></emu-xref>) Unicode string. Otherwise, let <var>Input</var> be a <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> consisting of the sequence of code units that are the elements of <var>str</var>. <var>Input</var> will be used throughout the algorithms in <emu-xref href="#sec-pattern-semantics"><a href="https://tc39.github.io/ecma262/#sec-pattern-semantics">21.2.2</a></emu-xref>. Each element of <var>Input</var> is considered to be a character.</li><li>Let <var>InputLength</var> be the number of characters contained in <var>Input</var>. This variable will be used throughout the algorithms in <emu-xref href="#sec-pattern-semantics"><a href="https://tc39.github.io/ecma262/#sec-pattern-semantics">21.2.2</a></emu-xref>.</li><li>Let <var>listIndex</var> be the index into <var>Input</var> of the character that was obtained from element <var>index</var> of <var>str</var>.</li><li>Let <var>c</var> be a Continuation that always returns its State argument as a successful MatchResult.</li><li>Let <var>cap</var> be a <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> of <var>NcapturingParens</var> <emu-val>undefined</emu-val> values, indexed 1 through <var>NcapturingParens</var>.</li><li>Let <var>x</var> be the State (<var>listIndex</var>, <var>cap</var>).</li><li>Call <var>m</var>(<var>x</var>, <var>c</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>A Pattern evaluates (“compiles”) to an internal procedure value. <emu-xref aoid="RegExpBuiltinExec" id="_ref_0"><a href="https://tc39.github.io/ecma262/#sec-regexpbuiltinexec">RegExpBuiltinExec</a></emu-xref> can then apply this procedure to a String and an offset within the String to determine whether the pattern would match starting at exactly that offset within the String, and, if it does match, what the values of the capturing parentheses would be. The algorithms in  <emu-xref href="#sec-pattern-semantics"><a href="https://tc39.github.io/ecma262/#sec-pattern-semantics">21.2.2</a></emu-xref> are designed so that compiling a pattern may throw a <emu-val>SyntaxError</emu-val> exception; on the other hand, once the pattern is successfully compiled, applying the resulting internal procedure to find a match in a String cannot throw an exception (except for any host-defined exceptions that can occur anywhere such as out-of-memory).</p>
  </div></emu-note>
</emu-clause>

<!-- es6num="21.2.2.3" -->
<emu-clause id="sec-disjunction">
  <h1><span class="secnum">3.2</span>Disjunction</h1>
  <p><ins>With argument <var>direction</var>.</ins></p>
  <p>The production  <emu-grammar><emu-production name="Disjunction" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="3b74e96e"><emu-nt id="_ref_79"><a href="#prod-Alternative">Alternative</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates by evaluating <emu-nt id="_ref_80"><a href="#prod-Alternative">Alternative</a></emu-nt> to obtain a Matcher and returning that Matcher.</p>
  <p>The production  <emu-grammar><emu-production name="Disjunction" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="253d8b05"><emu-nt id="_ref_81"><a href="#prod-Alternative">Alternative</a></emu-nt><emu-t>|</emu-t><emu-nt id="_ref_82"><a href="#prod-Disjunction">Disjunction</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_83"><a href="#prod-Alternative">Alternative</a></emu-nt> <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m1</var>.</li><li>Evaluate <emu-nt id="_ref_84"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m2</var>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:<ol><li>Call <var>m1</var>(<var>x</var>, <var>c</var>) and let <var>r</var> be its result.</li><li>If <var>r</var> is not <emu-const>failure</emu-const>, return <var>r</var>.</li><li>Call <var>m2</var>(<var>x</var>, <var>c</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>The <code>|</code> regular expression operator separates two alternatives. The pattern first tries to match the left <emu-nt id="_ref_85"><a href="#prod-Alternative">Alternative</a></emu-nt> (followed by the sequel of the regular expression); if it fails, it tries to match the right <emu-nt id="_ref_86"><a href="#prod-Disjunction">Disjunction</a></emu-nt> (followed by the sequel of the regular expression). If the left <emu-nt id="_ref_87"><a href="#prod-Alternative">Alternative</a></emu-nt>, the right <emu-nt id="_ref_88"><a href="#prod-Disjunction">Disjunction</a></emu-nt>, and the sequel all have choice points, all choices in the sequel are tried before moving on to the next choice in the left <emu-nt id="_ref_89"><a href="#prod-Alternative">Alternative</a></emu-nt>. If choices in the left <emu-nt id="_ref_90"><a href="#prod-Alternative">Alternative</a></emu-nt> are exhausted, the right <emu-nt id="_ref_91"><a href="#prod-Disjunction">Disjunction</a></emu-nt> is tried instead of the left <emu-nt id="_ref_92"><a href="#prod-Alternative">Alternative</a></emu-nt>. Any capturing parentheses inside a portion of the pattern skipped by <code>|</code> produce <emu-val>undefined</emu-val> values instead of Strings. Thus, for example,</p>
    <pre><code class="javascript hljs">/a|ab/.exec(<span class="hljs-string">"abc"</span>)</code></pre>
    <p>returns the result <code>"a"</code> and not <code>"ab"</code>. Moreover,</p>
    <pre><code class="javascript hljs">/((a)|(ab))((c)|(bc))/.exec(<span class="hljs-string">"abc"</span>)</code></pre>
    <p>returns the array</p>
    <pre><code class="javascript hljs">[<span class="hljs-string">"abc"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"bc"</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"bc"</span>]</code></pre>
    <p>and not</p>
    <pre><code class="javascript hljs">[<span class="hljs-string">"abc"</span>, <span class="hljs-string">"ab"</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"ab"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-literal">undefined</span>]</code></pre>
    <ins class="block"><p>The order in which the two alternatives are tried is independent of the value of <var>direction</var>.</p></ins>
  </div></emu-note>
  
</emu-clause>

<!-- es6num="21.2.2.4" -->
<emu-clause id="sec-alternative">
  <h1><span class="secnum">3.3</span>Alternative</h1>
  <p><ins>With argument <var>direction</var>.</ins></p>
  <p>The production  <emu-grammar><emu-production name="Alternative" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Alternative">Alternative</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="37b9c04c"><emu-gann>[empty]</emu-gann></emu-rhs>
</emu-production></emu-grammar> evaluates by returning a Matcher that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and returns the result of calling <var>c</var>(<var>x</var>).</p>
  <p>The production  <emu-grammar><emu-production name="Alternative" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Alternative">Alternative</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="bdc4c1a6"><emu-nt id="_ref_93"><a href="#prod-Alternative">Alternative</a></emu-nt><emu-nt id="_ref_94"><a href="#prod-Term">Term</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_95"><a href="#prod-Alternative">Alternative</a></emu-nt> <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m1</var>.</li><li>Evaluate <emu-nt id="_ref_96"><a href="#prod-Term">Term</a></emu-nt> <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m2</var>.</li><li><ins>If <var>direction</var> is equal to +1, then,</ins><ol><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:<ol><li>Let <var>d</var> be a Continuation that takes a State argument <var>y</var> and returns the result of calling <var>m2</var>(<var>y</var>, <var>c</var>).</li><li>Call <var>m1</var>(<var>x</var>, <var>d</var>) and return its result.</li></ol></li></ol></li><li><ins>Else, <var>direction</var> is equal to -1.</ins><ol><li><ins>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:</ins><ol><li><ins>Let <var>d</var> be a Continuation that takes a State argument <var>y</var> and returns the result of calling <var>m1</var>(<var>y</var>, <var>c</var>).</ins></li><li><ins>Call <var>m2</var>(<var>x</var>, <var>d</var>) and return its result.</ins>
  </li></ol></li></ol></li></ol></emu-alg>
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>Consecutive <emu-nt id="_ref_97"><a href="#prod-Term">Term</a></emu-nt>s try to simultaneously match consecutive portions of <var>Input</var>.
    
    <ins>When <var>direction</var> is equal to +1,</ins> if the left <emu-nt id="_ref_98"><a href="#prod-Alternative">Alternative</a></emu-nt>, the right <emu-nt id="_ref_99"><a href="#prod-Term">Term</a></emu-nt>, and the sequel of the regular expression all have choice points, all choices in the sequel are tried before moving on to the next choice in the right <emu-nt id="_ref_100"><a href="#prod-Term">Term</a></emu-nt>, and all choices in the right <emu-nt id="_ref_101"><a href="#prod-Term">Term</a></emu-nt> are tried before moving on to the next choice in the left <emu-nt id="_ref_102"><a href="#prod-Alternative">Alternative</a></emu-nt>.</p>
    <ins>When <var>direction</var> is equal to -1, the evaluation order of <emu-nt id="_ref_103"><a href="#prod-Alternative">Alternative</a></emu-nt> and <emu-nt id="_ref_104"><a href="#prod-Term">Term</a></emu-nt> are reversed.</ins>
  </div></emu-note>
</emu-clause>

<!-- es6num="21.2.2.5" -->
<emu-clause id="sec-term">
  <h1><span class="secnum">3.4</span>Term</h1>
  <p><ins>With argument <var>direction</var>.</ins></p>
  <p>The production  <emu-grammar><emu-production name="Term" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Term">Term</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="e03dc251"><emu-nt id="_ref_105"><a href="#prod-Assertion">Assertion</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates by returning an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_106"><a href="#prod-Assertion">Assertion</a></emu-nt> to obtain an AssertionTester <var>t</var>.</li><li>Call <var>t</var>(<var>x</var>) and let <var>r</var> be the resulting Boolean value.</li><li>If <var>r</var> is <emu-val>false</emu-val>, return <emu-const>failure</emu-const>.</li><li>Call <var>c</var>(<var>x</var>) and return its result.
  </li></ol></emu-alg>
  <ins class="block">
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>The AssertionTester is independent of <var>direction</var>.</p>
  </div></emu-note>
  </ins>
  <p>The production  <emu-grammar><emu-production name="Term" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Term">Term</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="41dded41"><emu-nt id="_ref_107"><a href="#prod-Atom">Atom</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Return the Matcher that is the result of evaluating <emu-nt id="_ref_108"><a href="#prod-Atom">Atom</a></emu-nt> <ins>with argument <var>direction</var></ins>.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Term" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Term">Term</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="44aed0a4"><emu-nt id="_ref_109"><a href="#prod-Atom">Atom</a></emu-nt><emu-nt id="_ref_110"><a href="#prod-Quantifier">Quantifier</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_111"><a href="#prod-Atom">Atom</a></emu-nt>  <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m</var>.</li><li>Evaluate <emu-nt id="_ref_112"><a href="#prod-Quantifier">Quantifier</a></emu-nt> to obtain the three results: an integer <var>min</var>, an integer (or ∞) <var>max</var>, and Boolean <var>greedy</var>.</li><li>If <var>max</var> is finite and less than <var>min</var>, throw a <emu-val>SyntaxError</emu-val> exception.</li><li>Let <var>parenIndex</var> be the number of left capturing parentheses in the entire regular expression that occur to the left of this production expansion's <emu-nt id="_ref_113"><a href="#prod-Term">Term</a></emu-nt>. This is the total number of times the <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_114"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> production is expanded prior to this production's <emu-nt id="_ref_115"><a href="#prod-Term">Term</a></emu-nt> plus the total number of <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_116"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> productions enclosing this <emu-nt id="_ref_117"><a href="#prod-Term">Term</a></emu-nt>.</li><li>Let <var>parenCount</var> be the number of left capturing parentheses in the expansion of this production's <emu-nt id="_ref_118"><a href="#prod-Atom">Atom</a></emu-nt>. This is the total number of <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_119"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> productions enclosed by this production's <emu-nt id="_ref_120"><a href="#prod-Atom">Atom</a></emu-nt>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:<ol><li>Call <emu-xref aoid="RepeatMatcher" id="_ref_1"><a href="#sec-runtime-semantics-repeatmatcher-abstract-operation">RepeatMatcher</a></emu-xref>(<var>m</var>, <var>min</var>, <var>max</var>, <var>greedy</var>, <var>x</var>, <var>c</var>, <var>parenIndex</var>, <var>parenCount</var>) and return its result.
  </li></ol></li></ol></emu-alg>

  <!-- es6num="21.2.2.5.1" -->
  <emu-clause id="sec-runtime-semantics-repeatmatcher-abstract-operation" aoid="RepeatMatcher">
    <h1><span class="secnum">3.4.1</span>Runtime Semantics: RepeatMatcher Abstract Operation</h1>
    <p>The abstract operation RepeatMatcher takes eight parameters, a Matcher <var>m</var>, an integer <var>min</var>, an integer (or ∞) <var>max</var>, a Boolean <var>greedy</var>, a State <var>x</var>, a Continuation <var>c</var>, an integer <var>parenIndex</var>, and an integer <var>parenCount</var>, and performs the following steps:</p>
    <emu-alg><ol><li>If <var>max</var> is zero, return <var>c</var>(<var>x</var>).</li><li>Let <var>d</var> be an internal Continuation closure that takes one State argument <var>y</var> and performs the following steps when evaluated:<ol><li>If <var>min</var> is zero and <var>y</var>'s <var>endIndex</var> is equal to <var>x</var>'s <var>endIndex</var>, return <emu-const>failure</emu-const>.</li><li>If <var>min</var> is zero, let <var>min2</var> be zero; otherwise let <var>min2</var> be <var>min</var>-1.</li><li>If <var>max</var> is ∞, let <var>max2</var> be ∞; otherwise let <var>max2</var> be <var>max</var>-1.</li><li>Call <emu-xref aoid="RepeatMatcher" id="_ref_2"><a href="#sec-runtime-semantics-repeatmatcher-abstract-operation">RepeatMatcher</a></emu-xref>(<var>m</var>, <var>min2</var>, <var>max2</var>, <var>greedy</var>, <var>y</var>, <var>c</var>, <var>parenIndex</var>, <var>parenCount</var>) and return its result.</li></ol></li><li>Let <var>cap</var> be a fresh copy of <var>x</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>For each integer <var>k</var> that satisfies <var>parenIndex</var> &lt; <var>k</var> and <var>k</var> ≤ <var>parenIndex</var>+<var>parenCount</var>, set <var>cap</var>[<var>k</var>] to <emu-val>undefined</emu-val>.</li><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Let <var>xr</var> be the State (<var>e</var>, <var>cap</var>).</li><li>If <var>min</var> is not zero, return <var>m</var>(<var>xr</var>, <var>d</var>).</li><li>If <var>greedy</var> is <emu-val>false</emu-val>, then<ol><li>Call <var>c</var>(<var>x</var>) and let <var>z</var> be its result.</li><li>If <var>z</var> is not <emu-const>failure</emu-const>, return <var>z</var>.</li><li>Call <var>m</var>(<var>xr</var>, <var>d</var>) and return its result.</li></ol></li><li>Call <var>m</var>(<var>xr</var>, <var>d</var>) and let <var>z</var> be its result.</li><li>If <var>z</var> is not <emu-const>failure</emu-const>, return <var>z</var>.</li><li>Call <var>c</var>(<var>x</var>) and return its result.
    </li></ol></emu-alg>
    <emu-note><span class="note">Note 1</span><div class="note-contents">
      <p>An <emu-nt id="_ref_121"><a href="#prod-Atom">Atom</a></emu-nt> followed by a <emu-nt id="_ref_122"><a href="#prod-Quantifier">Quantifier</a></emu-nt> is repeated the number of times specified by the <emu-nt id="_ref_123"><a href="#prod-Quantifier">Quantifier</a></emu-nt>. A <emu-nt id="_ref_124"><a href="#prod-Quantifier">Quantifier</a></emu-nt> can be non-greedy, in which case the <emu-nt id="_ref_125"><a href="#prod-Atom">Atom</a></emu-nt> pattern is repeated as few times as possible while still matching the sequel, or it can be greedy, in which case the <emu-nt id="_ref_126"><a href="#prod-Atom">Atom</a></emu-nt> pattern is repeated as many times as possible while still matching the sequel. The <emu-nt id="_ref_127"><a href="#prod-Atom">Atom</a></emu-nt> pattern is repeated rather than the input character sequence that it matches, so different repetitions of the <emu-nt id="_ref_128"><a href="#prod-Atom">Atom</a></emu-nt> can match different input substrings.</p>
    </div></emu-note>
    <emu-note><span class="note">Note 2</span><div class="note-contents">
      <p>If the <emu-nt id="_ref_129"><a href="#prod-Atom">Atom</a></emu-nt> and the sequel of the regular expression all have choice points, the <emu-nt id="_ref_130"><a href="#prod-Atom">Atom</a></emu-nt> is first matched as many (or as few, if non-greedy) times as possible. All choices in the sequel are tried before moving on to the next choice in the last repetition of <emu-nt id="_ref_131"><a href="#prod-Atom">Atom</a></emu-nt>. All choices in the last (n<sup>th</sup>) repetition of <emu-nt id="_ref_132"><a href="#prod-Atom">Atom</a></emu-nt> are tried before moving on to the next choice in the next-to-last (n-1)<sup>st</sup> repetition of <emu-nt id="_ref_133"><a href="#prod-Atom">Atom</a></emu-nt>; at which point it may turn out that more or fewer repetitions of <emu-nt id="_ref_134"><a href="#prod-Atom">Atom</a></emu-nt> are now possible; these are exhausted (again, starting with either as few or as many as possible) before moving on to the next choice in the (n-1)<sup>st</sup> repetition of <emu-nt id="_ref_135"><a href="#prod-Atom">Atom</a></emu-nt> and so on.</p>
      <p>Compare</p>
      <pre><code class="javascript hljs">/a[a-z]{<span class="hljs-number">2</span>,<span class="hljs-number">4</span>}/.exec(<span class="hljs-string">"abcdefghi"</span>)</code></pre>
      <p>which returns <code>"abcde"</code> with</p>
      <pre><code class="javascript hljs">/a[a-z]{<span class="hljs-number">2</span>,<span class="hljs-number">4</span>}?<span class="hljs-regexp">/.exec("abcdefghi")</span></code></pre>
      <p>which returns <code>"abc"</code>.</p>
      <p>Consider also</p>
      <pre><code class="javascript hljs">/(aa|aabaac|ba|b|c)*<span class="hljs-regexp">/.exec("aabaac")</span></code></pre>
      <p>which, by the choice point ordering above, returns the array</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"aaba"</span>, <span class="hljs-string">"ba"</span>]</code></pre>
      <p>and not any of:</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"aabaac"</span>, <span class="hljs-string">"aabaac"</span>]
[<span class="hljs-string">"aabaac"</span>, <span class="hljs-string">"c"</span>]</code></pre>
      <p>The above ordering of choice points can be used to write a regular expression that calculates the greatest common divisor of two numbers (represented in unary notation). The following example calculates the gcd of 10 and 15:</p>
      <pre><code class="javascript hljs"><span class="hljs-string">"aaaaaaaaaa,aaaaaaaaaaaaaaa"</span>.replace(<span class="hljs-regexp">/^(a+)\1*,\1+$/</span>,<span class="hljs-string">"$1"</span>)</code></pre>
      <p>which returns the gcd in unary notation <code>"aaaaa"</code>.</p>
    </div></emu-note>
    <emu-note><span class="note">Note 3</span><div class="note-contents">
      <p>Step 4 of the RepeatMatcher clears <emu-nt id="_ref_136"><a href="#prod-Atom">Atom</a></emu-nt>'s captures each time <emu-nt id="_ref_137"><a href="#prod-Atom">Atom</a></emu-nt> is repeated. We can see its behaviour in the regular expression</p>
      <pre><code class="javascript hljs">/(z)((a+)?(b+)?(c))*<span class="hljs-regexp">/.exec("zaacbbbcac")</span></code></pre>
      <p>which returns the array</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"zaacbbbcac"</span>, <span class="hljs-string">"z"</span>, <span class="hljs-string">"ac"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"c"</span>]</code></pre>
      <p>and not</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"zaacbbbcac"</span>, <span class="hljs-string">"z"</span>, <span class="hljs-string">"ac"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"c"</span>]</code></pre>
      <p>because each iteration of the outermost <code>*</code> clears all captured Strings contained in the quantified <emu-nt id="_ref_138"><a href="#prod-Atom">Atom</a></emu-nt>, which in this case includes capture Strings numbered 2, 3, 4, and 5.</p>
    </div></emu-note>
    <emu-note><span class="note">Note 4</span><div class="note-contents">
      <p>Step 1 of the RepeatMatcher's <var>d</var> closure states that, once the minimum number of repetitions has been satisfied, any more expansions of <emu-nt id="_ref_139"><a href="#prod-Atom">Atom</a></emu-nt> that match the empty character sequence are not considered for further repetitions. This prevents the regular expression engine from falling into an infinite loop on patterns such as:</p>
      <pre><code class="javascript hljs">/(a*)*<span class="hljs-regexp">/.exec("b")</span></code></pre>
      <p>or the slightly more complicated:</p>
      <pre><code class="javascript hljs">/(a*)b\<span class="hljs-number">1</span>+<span class="hljs-regexp">/.exec("baaaac")</span></code></pre>
      <p>which returns the array</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"b"</span>, <span class="hljs-string">""</span>]</code></pre>
    </div></emu-note>
  </emu-clause>
</emu-clause>

<!-- es6num="21.2.2.6" -->
<emu-clause id="sec-assertion">
  <h1><span class="secnum">3.5</span>Assertion</h1>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="e5878811"><emu-t>^</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates by returning an internal AssertionTester closure that takes a State argument <var>x</var> and performs the following steps when evaluated:</p>
  <emu-alg><ol><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>If <var>e</var> is zero, return <emu-val>true</emu-val>.</li><li>If <var>Multiline</var> is <emu-val>false</emu-val>, return <emu-val>false</emu-val>.</li><li>If the character <var>Input</var>[<var>e</var>-1] is one of <emu-nt><a href="https://tc39.github.io/ecma262/#prod-LineTerminator">LineTerminator</a></emu-nt>, return <emu-val>true</emu-val>.</li><li>Return <emu-val>false</emu-val>.
  </li></ol></emu-alg>
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>Even when the <code>y</code> flag is used with a pattern, <code>^</code> always matches only at the beginning of <var>Input</var>, or (if <var>Multiline</var> is <emu-val>true</emu-val>) at the beginning of a line.</p>
  </div></emu-note>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="1262cc92"><emu-t>$</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates by returning an internal AssertionTester closure that takes a State argument <var>x</var> and performs the following steps when evaluated:</p>
  <emu-alg><ol><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>If <var>e</var> is equal to <var>InputLength</var>, return <emu-val>true</emu-val>.</li><li>If <var>Multiline</var> is <emu-val>false</emu-val>, return <emu-val>false</emu-val>.</li><li>If the character <var>Input</var>[<var>e</var>] is one of <emu-nt><a href="https://tc39.github.io/ecma262/#prod-LineTerminator">LineTerminator</a></emu-nt>, return <emu-val>true</emu-val>.</li><li>Return <emu-val>false</emu-val>.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="1e228da5"><emu-t>\</emu-t><emu-t>b</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates by returning an internal AssertionTester closure that takes a State argument <var>x</var> and performs the following steps when evaluated:</p>
  <emu-alg><ol><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Call <emu-xref aoid="IsWordChar" id="_ref_3"><a href="#sec-runtime-semantics-iswordchar-abstract-operation">IsWordChar</a></emu-xref>(<var>e</var>-1) and let <var>a</var> be the Boolean result.</li><li>Call <emu-xref aoid="IsWordChar" id="_ref_4"><a href="#sec-runtime-semantics-iswordchar-abstract-operation">IsWordChar</a></emu-xref>(<var>e</var>) and let <var>b</var> be the Boolean result.</li><li>If <var>a</var> is <emu-val>true</emu-val> and <var>b</var> is <emu-val>false</emu-val>, return <emu-val>true</emu-val>.</li><li>If <var>a</var> is <emu-val>false</emu-val> and <var>b</var> is <emu-val>true</emu-val>, return <emu-val>true</emu-val>.</li><li>Return <emu-val>false</emu-val>.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="a5dc97fa"><emu-t>\</emu-t><emu-t>B</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates by returning an internal AssertionTester closure that takes a State argument <var>x</var> and performs the following steps when evaluated:</p>
  <emu-alg><ol><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Call <emu-xref aoid="IsWordChar" id="_ref_5"><a href="#sec-runtime-semantics-iswordchar-abstract-operation">IsWordChar</a></emu-xref>(<var>e</var>-1) and let <var>a</var> be the Boolean result.</li><li>Call <emu-xref aoid="IsWordChar" id="_ref_6"><a href="#sec-runtime-semantics-iswordchar-abstract-operation">IsWordChar</a></emu-xref>(<var>e</var>) and let <var>b</var> be the Boolean result.</li><li>If <var>a</var> is <emu-val>true</emu-val> and <var>b</var> is <emu-val>false</emu-val>, return <emu-val>false</emu-val>.</li><li>If <var>a</var> is <emu-val>false</emu-val> and <var>b</var> is <emu-val>true</emu-val>, return <emu-val>false</emu-val>.</li><li>Return <emu-val>true</emu-val>.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="cfb94f94"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>=</emu-t><emu-nt id="_ref_140"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_141"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with +1 as its <var>direction</var> argument</ins> to obtain a Matcher <var>m</var>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>d</var> be a Continuation that always returns its State argument as a successful MatchResult.</li><li>Call <var>m</var>(<var>x</var>, <var>d</var>) and let <var>r</var> be its result.</li><li>If <var>r</var> is <emu-const>failure</emu-const>, return <emu-const>failure</emu-const>.</li><li>Let <var>y</var> be <var>r</var>'s State.</li><li>Let <var>cap</var> be <var>y</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>xe</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Let <var>z</var> be the State (<var>xe</var>, <var>cap</var>).</li><li>Call <var>c</var>(<var>z</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="ba98f6e2"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>!</emu-t><emu-nt id="_ref_142"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_143"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with +1 as its <var>direction</var> argument</ins> to obtain a Matcher <var>m</var>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>d</var> be a Continuation that always returns its State argument as a successful MatchResult.</li><li>Call <var>m</var>(<var>x</var>, <var>d</var>) and let <var>r</var> be its result.</li><li>If <var>r</var> is not <emu-const>failure</emu-const>, return <emu-const>failure</emu-const>.</li><li>Call <var>c</var>(<var>x</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <ins class="block">
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="4cab1004"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>&lt;=</emu-t><emu-nt id="_ref_144"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_145"><a href="#prod-Disjunction">Disjunction</a></emu-nt> with -1 as its <var>direction</var> argument to obtain a Matcher <var>m</var>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>d</var> be a Continuation that always returns its State argument as a successful MatchResult.</li><li>Call <var>m</var>(<var>x</var>, <var>d</var>) and let <var>r</var> be its result.</li><li>If <var>r</var> is <emu-const>failure</emu-const>, return <emu-const>failure</emu-const>.</li><li>Let <var>y</var> be <var>r</var>'s State.</li><li>Let <var>cap</var> be <var>y</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>xe</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Let <var>z</var> be the State (<var>xe</var>, <var>cap</var>).</li><li>Call <var>c</var>(<var>z</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Assertion" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Assertion">Assertion</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="74e75484"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>&lt;!</emu-t><emu-nt id="_ref_146"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_147"><a href="#prod-Disjunction">Disjunction</a></emu-nt> with -1 as its <var>direction</var> argument to obtain a Matcher <var>m</var>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>d</var> be a Continuation that always returns its State argument as a successful MatchResult.</li><li>Call <var>m</var>(<var>x</var>, <var>d</var>) and let <var>r</var> be its result.</li><li>If <var>r</var> is not <emu-const>failure</emu-const>, return <emu-const>failure</emu-const>.</li><li>Call <var>c</var>(<var>x</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  </ins>

  <!-- es6num="21.2.2.6.1" -->
  <emu-clause id="sec-runtime-semantics-wordcharacters-abstract-operation" aoid="WordCharacters">
    <h1><span class="secnum">3.5.1</span>Runtime Semantics: WordCharacters Abstract Operation</h1>
    <p>The abstract operation WordCharacters performs the following steps:</p>
    <emu-alg><ol><li>Let <var>A</var> be a set of characters containing the sixty-three characters:
      <figure>
        <table class="lightweight-table">
          <tbody>
            <tr>
              <td>
                <code>a</code>
              </td>
              <td>
                <code>b</code>
              </td>
              <td>
                <code>c</code>
              </td>
              <td>
                <code>d</code>
              </td>
              <td>
                <code>e</code>
              </td>
              <td>
                <code>f</code>
              </td>
              <td>
                <code>g</code>
              </td>
              <td>
                <code>h</code>
              </td>
              <td>
                <code>i</code>
              </td>
              <td>
                <code>j</code>
              </td>
              <td>
                <code>k</code>
              </td>
              <td>
                <code>l</code>
              </td>
              <td>
                <code>m</code>
              </td>
              <td>
                <code>n</code>
              </td>
              <td>
                <code>o</code>
              </td>
              <td>
                <code>p</code>
              </td>
              <td>
                <code>q</code>
              </td>
              <td>
                <code>r</code>
              </td>
              <td>
                <code>s</code>
              </td>
              <td>
                <code>t</code>
              </td>
              <td>
                <code>u</code>
              </td>
              <td>
                <code>v</code>
              </td>
              <td>
                <code>w</code>
              </td>
              <td>
                <code>x</code>
              </td>
              <td>
                <code>y</code>
              </td>
              <td>
                <code>z</code>
              </td>
            </tr>
            <tr>
              <td>
                <code>A</code>
              </td>
              <td>
                <code>B</code>
              </td>
              <td>
                <code>C</code>
              </td>
              <td>
                <code>D</code>
              </td>
              <td>
                <code>E</code>
              </td>
              <td>
                <code>F</code>
              </td>
              <td>
                <code>G</code>
              </td>
              <td>
                <code>H</code>
              </td>
              <td>
                <code>I</code>
              </td>
              <td>
                <code>J</code>
              </td>
              <td>
                <code>K</code>
              </td>
              <td>
                <code>L</code>
              </td>
              <td>
                <code>M</code>
              </td>
              <td>
                <code>N</code>
              </td>
              <td>
                <code>O</code>
              </td>
              <td>
                <code>P</code>
              </td>
              <td>
                <code>Q</code>
              </td>
              <td>
                <code>R</code>
              </td>
              <td>
                <code>S</code>
              </td>
              <td>
                <code>T</code>
              </td>
              <td>
                <code>U</code>
              </td>
              <td>
                <code>V</code>
              </td>
              <td>
                <code>W</code>
              </td>
              <td>
                <code>X</code>
              </td>
              <td>
                <code>Y</code>
              </td>
              <td>
                <code>Z</code>
              </td>
            </tr>
            <tr>
              <td>
                <code>0</code>
              </td>
              <td>
                <code>1</code>
              </td>
              <td>
                <code>2</code>
              </td>
              <td>
                <code>3</code>
              </td>
              <td>
                <code>4</code>
              </td>
              <td>
                <code>5</code>
              </td>
              <td>
                <code>6</code>
              </td>
              <td>
                <code>7</code>
              </td>
              <td>
                <code>8</code>
              </td>
              <td>
                <code>9</code>
              </td>
              <td>
                <code>_</code>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
              <td>
              </td>
            </tr>
          </tbody>
        </table>
      </figure></li><li>Let <var>U</var> be an empty set.</li><li>For each character <var>c</var> not in set <var>A</var> where <emu-xref aoid="Canonicalize" id="_ref_7"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>c</var>) is in <var>A</var>, add <var>c</var> to <var>U</var>.</li><li>Assert: Unless <var>Unicode</var> and <var>IgnoreCase</var> are both <emu-val>true</emu-val>, <var>U</var> is empty.</li><li>Add the characters in set <var>U</var> to set <var>A</var>.</li><li>Return <var>A</var>.
    </li></ol></emu-alg>
  </emu-clause>
  <!-- es6num="21.2.2.6.2" -->
  <emu-clause id="sec-runtime-semantics-iswordchar-abstract-operation" aoid="IsWordChar">
    <h1><span class="secnum">3.5.2</span>Runtime Semantics: IsWordChar Abstract Operation</h1>
    <p>The abstract operation IsWordChar takes an integer parameter <var>e</var> and performs the following steps:</p>
    <emu-alg><ol><li>If <var>e</var> is -1 or <var>e</var> is <var>InputLength</var>, return <emu-val>false</emu-val>.</li><li>Let <var>c</var> be the character <var>Input</var>[<var>e</var>].</li><li>Let <var>wordChars</var> be the result of !&nbsp;<emu-xref aoid="WordCharacters" id="_ref_8"><a href="#sec-runtime-semantics-wordcharacters-abstract-operation">WordCharacters</a></emu-xref>().</li><li>If <var>c</var> is in <var>wordChars</var>, return <emu-val>true</emu-val>.</li><li>Return <emu-val>false</emu-val>.
    </li></ol></emu-alg>
  </emu-clause>
</emu-clause>

<!-- es6num="21.2.2.8" -->
<emu-clause id="sec-atom">
  <h1><span class="secnum">3.6</span>Atom</h1>
  <p><ins>With argument <var>direction</var>.</ins></p>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="beff52c4"><emu-nt id="_ref_148"><a href="#prod-PatternCharacter">PatternCharacter</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Let <var>ch</var> be the character matched by <emu-nt id="_ref_149"><a href="#prod-PatternCharacter">PatternCharacter</a></emu-nt>.</li><li>Let <var>A</var> be a one-element CharSet containing the character <var>ch</var>.</li><li>Call <emu-xref aoid="CharacterSetMatcher" id="_ref_9"><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation">CharacterSetMatcher</a></emu-xref>(<var>A</var>, <emu-val>false</emu-val><ins>, <var>direction</var></ins>) and return its Matcher result.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="9658e473"><emu-t>.</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Let <var>A</var> be the set of all characters except <emu-nt><a href="https://tc39.github.io/ecma262/#prod-LineTerminator">LineTerminator</a></emu-nt>.</li><li>Call <emu-xref aoid="CharacterSetMatcher" id="_ref_10"><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation">CharacterSetMatcher</a></emu-xref>(<var>A</var>, <emu-val>false</emu-val><ins>, <var>direction</var></ins>) and return its Matcher result.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="9ce67ea4"><emu-t>\</emu-t><emu-nt id="_ref_150"><a href="#prod-AtomEscape">AtomEscape</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Return the Matcher that is the result of evaluating <emu-nt id="_ref_151"><a href="#prod-AtomEscape">AtomEscape</a></emu-nt> <ins>with argument <var>direction</var></ins>.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="66aaa8b9"><emu-nt id="_ref_152"><a href="#prod-CharacterClass">CharacterClass</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_153"><a href="#prod-CharacterClass">CharacterClass</a></emu-nt> to obtain a CharSet <var>A</var> and a Boolean <var>invert</var>.</li><li>Call <emu-xref aoid="CharacterSetMatcher" id="_ref_11"><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation">CharacterSetMatcher</a></emu-xref>(<var>A</var>, <var>invert</var><ins>, <var>direction</var></ins>) and return its Matcher result.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_154"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_155"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with argument <var>direction</var></ins> to obtain a Matcher <var>m</var>.</li><li>Let <var>parenIndex</var> be the number of left capturing parentheses in the entire regular expression that occur to the left of this production expansion's initial left parenthesis. This is the total number of times the <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_156"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> production is expanded prior to this production's <emu-nt id="_ref_157"><a href="#prod-Atom">Atom</a></emu-nt> plus the total number of <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="34eb148f"><emu-t>(</emu-t><emu-nt id="_ref_158"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> productions enclosing this <emu-nt id="_ref_159"><a href="#prod-Atom">Atom</a></emu-nt>.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>d</var> be an internal Continuation closure that takes one State argument <var>y</var> and performs the following steps:<ol><li>Let <var>cap</var> be a fresh copy of <var>y</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>xe</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Let <var>ye</var> be <var>y</var>'s <var>endIndex</var>.</li><li><ins>If <var>direction</var> is equal +1, then</ins><ol><li>Let <var>s</var> be a fresh <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> whose characters are the characters of <var>Input</var> at indices <var>xe</var> (inclusive) through <var>ye</var> (exclusive).</li></ol></li><li><ins>Else, <var>direction</var> is equal to -1.</ins><ol><li><ins>Let <var>s</var> be a fresh <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> whose characters are the characters of <var>Input</var> at indices <var>ye</var> (inclusive) through <var>xe</var> (exclusive).</ins></li></ol></li><li>Set <var>cap</var>[<var>parenIndex</var>+1] to <var>s</var>.</li><li>Let <var>z</var> be the State (<var>ye</var>, <var>cap</var>).</li><li>Call <var>c</var>(<var>z</var>) and return its result.</li></ol></li><li>Call <var>m</var>(<var>x</var>, <var>d</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="Atom" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-Atom">Atom</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="d76db7c5"><emu-t>(</emu-t><emu-t>?</emu-t><emu-t>:</emu-t><emu-nt id="_ref_160"><a href="#prod-Disjunction">Disjunction</a></emu-nt><emu-t>)</emu-t></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Return the Matcher that is the result of evaluating <emu-nt id="_ref_161"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <ins>with argument <var>direction</var></ins>.
  </li></ol></emu-alg>

  <!-- es6num="21.2.2.8.1" -->
  <emu-clause id="sec-runtime-semantics-charactersetmatcher-abstract-operation" aoid="CharacterSetMatcher">
    <h1><span class="secnum">3.6.1</span>Runtime Semantics: CharacterSetMatcher Abstract Operation</h1>
    <p><ins>With argument <var>direction</var>.</ins></p>
    <p>The abstract operation CharacterSetMatcher takes  <del>two</del><ins>three</ins> arguments, a CharSet <var>A</var>, a Boolean flag <var>invert</var>  <ins>and an integer <var>direction</var></ins>, and performs the following steps:</p>
    <emu-alg><ol><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps when evaluated:<ol><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li><ins>Let <var>f</var> be <var>e</var> + <var>direction</var></ins>.</li><li><del>If <var>e</var> is <var>InputLength</var>, return <emu-const>failure</emu-const>.</del></li><li><ins>If <var>f</var> &lt; 0 or <var>f</var> &gt; <var>InputLength</var>, return <emu-const>failure</emu-const>.</ins></li><li><del>Let <var>ch</var> be the character <var>Input</var>[<var>e</var>].</del></li><li><ins>Let <var>index</var> be <emu-xref aoid="min"><a href="https://tc39.github.io/ecma262/#sec-algorithm-conventions">min</a></emu-xref>(<var>e</var>, <var>f</var>).</ins></li><li><ins>Let <var>ch</var> be the character <var>Input</var>[<var>index</var>].</ins>.</li><li>Let <var>cc</var> be <emu-xref aoid="Canonicalize" id="_ref_12"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>ch</var>).</li><li>If <var>invert</var> is <emu-val>false</emu-val>, then<ol><li>If there does not exist a member <var>a</var> of set <var>A</var> such that <emu-xref aoid="Canonicalize" id="_ref_13"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>a</var>) is <var>cc</var>, return <emu-const>failure</emu-const>.</li></ol></li><li>Else <var>invert</var> is <emu-val>true</emu-val>,<ol><li>If there exists a member <var>a</var> of set <var>A</var> such that <emu-xref aoid="Canonicalize" id="_ref_14"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>a</var>) is <var>cc</var>, return <emu-const>failure</emu-const>.</li></ol></li><li>Let <var>cap</var> be <var>x</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li><del>Let <var>y</var> be the State (<var>e</var>+1, <var>cap</var>).</del></li><li><ins>Let <var>y</var> be the State (<var>f</var>, <var>cap</var>).</ins></li><li>Call <var>c</var>(<var>y</var>) and return its result.
    </li></ol></li></ol></emu-alg>
  </emu-clause>

  <!-- es6num="21.2.2.8.2" -->
  <emu-clause id="sec-runtime-semantics-canonicalize-ch" aoid="Canonicalize">
    <h1><span class="secnum">3.6.2</span>Runtime Semantics: Canonicalize ( <var>ch</var> )</h1>
    <p>The abstract operation Canonicalize takes a character parameter <var>ch</var> and performs the following steps:</p>
    <emu-alg><ol><li>If <var>IgnoreCase</var> is <emu-val>false</emu-val>, return <var>ch</var>.</li><li>If <var>Unicode</var> is <emu-val>true</emu-val>, then<ol><li>If the file CaseFolding.txt of the Unicode Character Database provides a simple or common case folding mapping for <var>ch</var>, return the result of applying that mapping to <var>ch</var>.</li><li>Else, return <var>ch</var>.</li></ol></li><li>Else,<ol><li>Assert: <var>ch</var> is a UTF-16 code unit.</li><li>Let <var>s</var> be the ECMAScript String value consisting of the single code unit <var>ch</var>.</li><li>Let <var>u</var> be the same result produced as if by performing the algorithm for <code>String.prototype.toUpperCase</code> using <var>s</var> as the <emu-val>this</emu-val> value.</li><li>Assert: <var>u</var> is a String value.</li><li>If <var>u</var> does not consist of a single code unit, return <var>ch</var>.</li><li>Let <var>cu</var> be <var>u</var>'s single code unit element.</li><li>If <var>ch</var>'s code unit value ≥ 128 and <var>cu</var>'s code unit value &lt; 128, return <var>ch</var>.</li><li>Return <var>cu</var>.
    </li></ol></li></ol></emu-alg>
    <emu-note><span class="note">Note 1</span><div class="note-contents">
      <p>Parentheses of the form <code>(</code> <emu-nt id="_ref_162"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <code>)</code> serve both to group the components of the <emu-nt id="_ref_163"><a href="#prod-Disjunction">Disjunction</a></emu-nt> pattern together and to save the result of the match. The result can be used either in a backreference (<code>\</code> followed by a nonzero decimal number), referenced in a replace String, or returned as part of an array from the regular expression matching internal procedure. To inhibit the capturing behaviour of parentheses, use the form <code>(?:</code> <emu-nt id="_ref_164"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <code>)</code> instead.</p>
    </div></emu-note>
    <emu-note><span class="note">Note 2</span><div class="note-contents">
      <p>The form <code>(?=</code> <emu-nt id="_ref_165"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <code>)</code> specifies a zero-width positive lookahead. In order for it to succeed, the pattern inside <emu-nt id="_ref_166"><a href="#prod-Disjunction">Disjunction</a></emu-nt> must match at the current position, but the current position is not advanced before matching the sequel. If <emu-nt id="_ref_167"><a href="#prod-Disjunction">Disjunction</a></emu-nt> can match at the current position in several ways, only the first one is tried. Unlike other regular expression operators, there is no backtracking into a <code>(?=</code> form (this unusual behaviour is inherited from Perl). This only matters when the <emu-nt id="_ref_168"><a href="#prod-Disjunction">Disjunction</a></emu-nt> contains capturing parentheses and the sequel of the pattern contains backreferences to those captures.</p>
      <p>For example,</p>
      <pre><code class="javascript hljs">/(?=(a+))/.exec(<span class="hljs-string">"baaabac"</span>)</code></pre>
      <p>matches the empty String immediately after the first <code>b</code> and therefore returns the array:</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">""</span>, <span class="hljs-string">"aaa"</span>]</code></pre>
      <p>To illustrate the lack of backtracking into the lookahead, consider:</p>
      <pre><code class="javascript hljs">/(?=(a+))a*b\<span class="hljs-number">1</span>/.exec(<span class="hljs-string">"baaabac"</span>)</code></pre>
      <p>This expression returns</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"aba"</span>, <span class="hljs-string">"a"</span>]</code></pre>
      <p>and not:</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"aaaba"</span>, <span class="hljs-string">"a"</span>]</code></pre>
    </div></emu-note>
    <emu-note><span class="note">Note 3</span><div class="note-contents">
      <p>The form <code>(?!</code> <emu-nt id="_ref_169"><a href="#prod-Disjunction">Disjunction</a></emu-nt> <code>)</code> specifies a zero-width negative lookahead. In order for it to succeed, the pattern inside <emu-nt id="_ref_170"><a href="#prod-Disjunction">Disjunction</a></emu-nt> must fail to match at the current position. The current position is not advanced before matching the sequel. <emu-nt id="_ref_171"><a href="#prod-Disjunction">Disjunction</a></emu-nt> can contain capturing parentheses, but backreferences to them only make sense from within <emu-nt id="_ref_172"><a href="#prod-Disjunction">Disjunction</a></emu-nt> itself. Backreferences to these capturing parentheses from elsewhere in the pattern always return <emu-val>undefined</emu-val> because the negative lookahead must fail for the pattern to succeed. For example,</p>
      <pre><code class="javascript hljs">/(.*?)a(?!(a+)b\<span class="hljs-number">2</span>c)\<span class="hljs-number">2</span>(.*)/.exec(<span class="hljs-string">"baaabaac"</span>)</code></pre>
      <p>looks for an <code>a</code> not immediately followed by some positive number n of <code>a</code>'s, a <code>b</code>, another n <code>a</code>'s (specified by the first <code>\2</code>) and a <code>c</code>. The second <code>\2</code> is outside the negative lookahead, so it matches against <emu-val>undefined</emu-val> and therefore always succeeds. The whole expression returns the array:</p>
      <pre><code class="javascript hljs">[<span class="hljs-string">"baaabaac"</span>, <span class="hljs-string">"ba"</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"abaac"</span>]</code></pre>
    </div></emu-note>
    <emu-note><span class="note">Note 4</span><div class="note-contents">
      <p>In case-insignificant matches when <var>Unicode</var> is <emu-val>true</emu-val>, all characters are implicitly case-folded using the simple mapping provided by the Unicode standard immediately before they are compared. The simple mapping always maps to a single code point, so it does not map, for example, <code>"ß"</code> (U+00DF) to <code>"SS"</code>. It may however map a code point outside the Basic Latin range to a character within, for example, <code>"ſ"</code> (U+017F) to <code>"s"</code>. Such characters are not mapped if <var>Unicode</var> is <emu-val>false</emu-val>. This prevents Unicode code points such as U+017F and U+212A from matching regular expressions such as <code>/[a-z]/i</code>, but they will match <code>/[a-z]/ui</code>.</p>
    </div></emu-note>
  </emu-clause>
</emu-clause>

<!-- es6num="21.2.2.9" -->
<emu-clause id="sec-atomescape">
  <h1><span class="secnum">3.7</span>AtomEscape</h1>
  <p><ins>With argument <var>direction</var>.</ins></p>
  <p>The production  <emu-grammar><emu-production name="AtomEscape" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-AtomEscape">AtomEscape</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="7ebff96c"><emu-nt id="_ref_173"><a href="#prod-DecimalEscape">DecimalEscape</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_174"><a href="#prod-DecimalEscape">DecimalEscape</a></emu-nt> to obtain an integer <var>n</var>.</li><li>If <var>n</var>&gt;<var>NcapturingParens</var>, throw a <emu-val>SyntaxError</emu-val> exception.</li><li>Return an internal Matcher closure that takes two arguments, a State <var>x</var> and a Continuation <var>c</var>, and performs the following steps:<ol><li>Let <var>cap</var> be <var>x</var>'s <var>captures</var> <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>s</var> be <var>cap</var>[<var>n</var>].</li><li>If <var>s</var> is <emu-val>undefined</emu-val>, return <var>c</var>(<var>x</var>).</li><li>Let <var>e</var> be <var>x</var>'s <var>endIndex</var>.</li><li>Let <var>len</var> be <var>s</var>'s length.</li><li><del>Let <var>f</var> be <var>e</var>+<var>len</var>.</del></li><li><ins>Let <var>f</var> be <var>e</var> + <var>direction</var>×<var>len</var>.</ins></li><li>If <ins><var>f</var> &lt; 0 or</ins> <var>f</var>&gt;<var>InputLength</var>, return <emu-const>failure</emu-const>.</li><li><ins>Let <var>g</var> be <emu-xref aoid="min"><a href="https://tc39.github.io/ecma262/#sec-algorithm-conventions">min</a></emu-xref>(<var>e</var>, <var>f</var>).</ins></li><li>If there exists an integer <var>i</var> between 0 (inclusive) and <var>len</var> (exclusive) such that <emu-xref aoid="Canonicalize" id="_ref_15"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>s</var>[<var>i</var>]) is not the same character value as <emu-xref aoid="Canonicalize" id="_ref_16"><a href="#sec-runtime-semantics-canonicalize-ch">Canonicalize</a></emu-xref>(<var>Input</var>[<del><var>e</var>+<var>i</var></del> <ins><var>g</var>+<var>i</var></ins>]), return <emu-const>failure</emu-const>.</li><li>Let <var>y</var> be the State (<var>f</var>, <var>cap</var>).</li><li>Call <var>c</var>(<var>y</var>) and return its result.
  </li></ol></li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="AtomEscape" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-AtomEscape">AtomEscape</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="163011be"><emu-nt id="_ref_175"><a href="#prod-CharacterEscape">CharacterEscape</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_176"><a href="#prod-CharacterEscape">CharacterEscape</a></emu-nt> to obtain a character <var>ch</var>.</li><li>Let <var>A</var> be a one-element CharSet containing the character <var>ch</var>.</li><li>Call <emu-xref aoid="CharacterSetMatcher" id="_ref_17"><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation">CharacterSetMatcher</a></emu-xref>(<var>A</var>, <emu-val>false</emu-val><ins>, <var>direction</var></ins>) and return its Matcher result.
  </li></ol></emu-alg>
  <p>The production  <emu-grammar><emu-production name="AtomEscape" type="lexical" collapsed="" class=" inline">
    <emu-nt><a href="#prod-AtomEscape">AtomEscape</a></emu-nt><emu-geq>::</emu-geq><emu-rhs a="6f05bee4"><emu-nt id="_ref_177"><a href="#prod-CharacterClassEscape">CharacterClassEscape</a></emu-nt></emu-rhs>
</emu-production></emu-grammar> evaluates as follows:</p>
  <emu-alg><ol><li>Evaluate <emu-nt id="_ref_178"><a href="#prod-CharacterClassEscape">CharacterClassEscape</a></emu-nt> to obtain a CharSet <var>A</var>.</li><li>Call <emu-xref aoid="CharacterSetMatcher" id="_ref_18"><a href="#sec-runtime-semantics-charactersetmatcher-abstract-operation">CharacterSetMatcher</a></emu-xref>(<var>A</var>, <emu-val>false</emu-val><ins>, <var>direction</var></ins>) and return its Matcher result.
  </li></ol></emu-alg>
  <emu-note><span class="note">Note</span><div class="note-contents">
    <p>An escape sequence of the form <code>\</code> followed by a nonzero decimal number <var>n</var> matches the result of the <var>n</var>th set of capturing parentheses (<emu-xref href="#sec-notation"><a href="https://tc39.github.io/ecma262/#sec-notation">21.2.2.1</a></emu-xref>). It is an error if the regular expression has fewer than <var>n</var> capturing parentheses. If the regular expression has <var>n</var> or more capturing parentheses but the <var>n</var>th one is <emu-val>undefined</emu-val> because it has not captured anything, then the backreference always succeeds.</p>
  </div></emu-note>
</emu-clause>
</emu-import>
</emu-clause>
</div></body>